http://www.depesz.com/2011/07/26/waiting-for-9-2-cascading-streaming-replication/
HTTP/1.1 200 OK
Server: nginx
Date: Wed, 23 Jul 2014 03:40:40 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2268>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Waiting for 9.2 &#8211; cascading streaming replication</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Waiting for 9.2 &#8211; cascading streaming replication Comments Feed" href="http://www.depesz.com/2011/07/26/waiting-for-9-2-cascading-streaming-replication/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2011/07/26/waiting-for-9-2-cascading-streaming-replication/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2268' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2268">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2011/07/26/waiting-for-9-2-cascading-streaming-replication/" rel="bookmark" title="Permanent Link to Waiting for 9.2 &#8211; cascading streaming replication">Waiting for 9.2 &#8211; cascading streaming replication</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>July 26th, 2011 by depesz | Tags: <a href="http://www.depesz.com/tag/cascade/" rel="tag">cascade</a>, <a href="http://www.depesz.com/tag/pg92/" rel="tag">pg92</a>, <a href="http://www.depesz.com/tag/pitr/" rel="tag">pitr</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/replication/" rel="tag">replication</a>, <a href="http://www.depesz.com/tag/slave/" rel="tag">slave</a>, <a href="http://www.depesz.com/tag/streaming/" rel="tag">streaming</a>, <a href="http://www.depesz.com/tag/wal/" rel="tag">wal</a> |  <a href="http://www.depesz.com/2011/07/26/waiting-for-9-2-cascading-streaming-replication/#comments" title="Comment on Waiting for 9.2 &#8211; cascading streaming replication">1 comment &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>On 19th of July, Simon Riggs <a href="http://archives.postgresql.org/pgsql-committers/2011-07/msg00193.php">committed</a> patch:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">Cascading replication feature <span style="color: #993333; font-weight: bold;">for</span> streaming log<span style="color: #66cc66;">-</span>based replication<span style="color: #66cc66;">.</span>
Standby servers can now have WALSender processes<span style="color: #66cc66;">,</span> which can <span style="color: #993333; font-weight: bold;">work</span> <span style="color: #993333; font-weight: bold;">with</span>
either WALReceiver <span style="color: #993333; font-weight: bold;">or</span> archive_commands <span style="color: #993333; font-weight: bold;">to</span> pass <span style="color: #993333; font-weight: bold;">data</span><span style="color: #66cc66;">.</span> Fully updated
docs<span style="color: #66cc66;">,</span> including <span style="color: #993333; font-weight: bold;">new</span> conceptual terms <span style="color: #993333; font-weight: bold;">of</span> sending server<span style="color: #66cc66;">,</span> upstream <span style="color: #993333; font-weight: bold;">and</span>
downstream servers<span style="color: #66cc66;">.</span> WALSenders <span style="color: #993333; font-weight: bold;">terminated</span> <span style="color: #993333; font-weight: bold;">when</span> promote <span style="color: #993333; font-weight: bold;">to</span> master<span style="color: #66cc66;">.</span>
&nbsp;
Fujii Masao<span style="color: #66cc66;">,</span> review<span style="color: #66cc66;">,</span> rework <span style="color: #993333; font-weight: bold;">and</span> doc rewrite <span style="color: #993333; font-weight: bold;">by</span> Simon Riggs</pre></td></tr></table></div>

<p><span id="more-2268"></span></p>
<p>Streaming replication is relatively new, <a href="http://www.depesz.com/index.php/2010/02/01/waiting-for-9-0-streaming-replication/">added in 9.0</a>. Since beginning it shared the same limitation that normal WAL-files based replication has, that is &#8211; there is only one <em>source</em> of data. That is master.</p>
<p>While it makes sense, it is also pretty cool to be able to make slave source of replication for some other systems. For example &#8211; not to keep master occupied with such tasks.</p>
<p>Now, with the patch, we can setup replication schema like this:</p>
<p><img src="/wp-content/uploads/2011/07/cascade.png"/></p>
<p>So, let's test it.</p>
<p>To make it work I will need some master database and 3 slaves, made off the master. Seems simple enough.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #c20cb9; font-weight: bold;">mkdir</span> master
&nbsp;
=$ initdb <span style="color: #660033;">-D</span> master
...
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">vim</span> master<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf</pre></td></tr></table></div>

<p>In the postgresql.conf, I change:</p>
<ul>
<li>port = 4001</li>
<li>wal_level = hot_standby</li>
<li>checkpoint_segments = 20</li>
<li>archive_mode = on</li>
<li>archive_command = &#8216;/bin/true'</li>
<li>max_wal_senders = 3</li>
<li>wal_keep_segments = 100</li>
<li>logging_collector = on</li>
<li>log_checkpoints = on</li>
<li>log_connections = on</li>
<li>log_line_prefix = &#8216;%m %r %u %d %p: &#8216;</li>
</ul>
<p>I also set pg_hba.conf to something that matches my test environment:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;"># TYPE  DATABASE        USER            ADDRESS                 METHOD
local   replication     all                                     trust
local   all             all                                     trust
host    all             all             127.0.0.1/32            trust</pre></td></tr></table></div>

<p>With master prepared that way, I can start it:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ pg_ctl <span style="color: #660033;">-D</span> master start
server starting
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">head</span> <span style="color: #660033;">-n</span> <span style="color: #000000;">1</span> master<span style="color: #000000; font-weight: bold;">/</span>postmaster.pid <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #660033;">-IPG</span> <span style="color: #c20cb9; font-weight: bold;">ps</span> uwf <span style="color: #660033;">-p</span> PG <span style="color: #660033;">--ppid</span> PG
USER       PID <span style="color: #000000; font-weight: bold;">%</span>CPU <span style="color: #000000; font-weight: bold;">%</span>MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
depesz    <span style="color: #000000;">9332</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">7496</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> master
depesz    <span style="color: #000000;">9333</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">724</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz    <span style="color: #000000;">9335</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">1276</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz    <span style="color: #000000;">9336</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">1012</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00  \_ postgres: wal writer process
depesz    <span style="color: #000000;">9337</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67164</span>  <span style="color: #000000;">2040</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00  \_ postgres: autovacuum launcher process
depesz    <span style="color: #000000;">9338</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">732</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00  \_ postgres: archiver process
depesz    <span style="color: #000000;">9339</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">932</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">11</span>   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
&nbsp;
=$ psql <span style="color: #660033;">-p</span> <span style="color: #000000;">4001</span> <span style="color: #660033;">-d</span> postgres <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;select version()&quot;</span>
                                                        version
<span style="color: #660033;">------------------------------------------------------------------------------------------------------------------------</span>
 PostgreSQL 9.2devel on x86_64-unknown-linux-gnu, compiled by gcc-<span style="color: #000000;">4.5</span>.real <span style="color: #7a0874; font-weight: bold;">&#40;</span>Ubuntu<span style="color: #000000; font-weight: bold;">/</span>Linaro 4.5.2-8ubuntu4<span style="color: #7a0874; font-weight: bold;">&#41;</span> 4.5.2, <span style="color: #000000;">64</span>-bit
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span> row<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>All looks ok.</p>
<p>One note &#8211; you might not understand why I used /bin/true as archive_command. Reason is very simple &#8211; archive has to be set to something, otherwise archive_mode cannot be enabled, and this will cause problems with backups, but on the other hand &#8211; I will not need to use the wal archive, since I have pretty large wal_keep_segments.</p>
<p>Now, we'll setup the slaves. Starting with the first one of course:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ psql <span style="color: #660033;">-p</span> <span style="color: #000000;">4001</span> <span style="color: #660033;">-d</span> postgres <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;select pg_start_backup('whatever')&quot;</span>
 pg_start_backup
<span style="color: #660033;">-----------------</span>
 <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">2000020</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span> row<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
=$ rsync <span style="color: #660033;">-a</span> master<span style="color: #000000; font-weight: bold;">/</span> slave<span style="color: #000000; font-weight: bold;">/</span>
&nbsp;
=$ psql <span style="color: #660033;">-p</span> <span style="color: #000000;">4001</span> <span style="color: #660033;">-d</span> postgres <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;select pg_stop_backup()&quot;</span>
NOTICE:  pg_stop_backup <span style="color: #7a0874; font-weight: bold;">complete</span>, all required WAL segments have been archived
 pg_stop_backup
<span style="color: #660033;">----------------</span>
 <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>20000D8
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span> row<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>Of course we need some tidying of the slave:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #c20cb9; font-weight: bold;">rm</span> <span style="color: #660033;">-f</span> slave<span style="color: #000000; font-weight: bold;">/</span>pg_xlog<span style="color: #000000; font-weight: bold;">/</span>???????????????????????? slave<span style="color: #000000; font-weight: bold;">/</span>pg_xlog<span style="color: #000000; font-weight: bold;">/</span>archive_status<span style="color: #000000; font-weight: bold;">/*</span> slave<span style="color: #000000; font-weight: bold;">/</span>pg_log<span style="color: #000000; font-weight: bold;">/*</span> slave<span style="color: #000000; font-weight: bold;">/</span>postmaster.pid
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">vim</span> slave<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf</pre></td></tr></table></div>

<p>In the config, I change:</p>
<ul>
<li>port = 4002</li>
<li>hot_standby = on</li>
</ul>
<p>And I also create recovery.conf in slave/, with this content:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">restore_command = '/bin/false'
standby_mode = 'on'
primary_conninfo = 'port=4001 user=depesz'
trigger_file = '/tmp/slave.finish.recovery'</pre></td></tr></table></div>

<p>And with this in place I can start slave:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">=$ pg_ctl -D slave start
server starting
&nbsp;
=$ head -n 1 slave/postmaster.pid | xargs -IPG ps uwf -p PG --ppid PG
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
depesz   13082  1.5  0.0  66484  7492 pts/3    S    12:51   0:00 /home/pgdba/work/bin/postgres -D slave
depesz   13083  0.0  0.0  26136   716 ?        Ss   12:51   0:00  \_ postgres: logger process
depesz   13084  0.0  0.0  66556  1428 ?        Ss   12:51   0:00  \_ postgres: startup process   recovering 000000010000000000000006
depesz   13087  2.7  0.0  81504  3064 ?        Ss   12:51   0:00  \_ postgres: wal receiver process   streaming 0/6000078
depesz   13091  0.0  0.0  66484  1012 ?        Ss   12:51   0:00  \_ postgres: writer process
depesz   13092  0.0  0.0  26132   896 ?        Ss   12:51   0:00  \_ postgres: stats collector process
&nbsp;
=$ head -n 1 master/postmaster.pid | xargs -IPG ps uwf -p PG --ppid PG
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
depesz   12981  0.2  0.0  66456  7520 pts/3    S    12:50   0:00 /home/pgdba/work/bin/postgres -D master
depesz   12982  0.0  0.0  26140   724 ?        Ss   12:50   0:00  \_ postgres: logger process
depesz   12984  0.0  0.0  66456  1016 ?        Ss   12:50   0:00  \_ postgres: writer process
depesz   12985  0.0  0.0  66456  1012 ?        Ss   12:50   0:00  \_ postgres: wal writer process
depesz   12986  0.0  0.0  67296  2096 ?        Ss   12:50   0:00  \_ postgres: autovacuum launcher process
depesz   12987  0.0  0.0  26136   732 ?        Ss   12:50   0:00  \_ postgres: archiver process
depesz   12988  0.0  0.0  26136  1040 ?        Ss   12:50   0:00  \_ postgres: stats collector process
depesz   13088  0.3  0.0  67428  2480 ?        Ss   12:51   0:00  \_ postgres: wal sender process depesz [local] streaming 0/6000078</pre></td></tr></table></div>

<p>One note &#8211; I used &#8220;user=depesz" in primary_conninfo, because I run the tests on depesz system account, and initdb made superuser named depesz, and not postgres.</p>
<p>So, we now have replication master -&gt; slave setup, so we can test it:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #66cc66;">=</span>$ psql <span style="color: #66cc66;">-</span>p <span style="color: #cc66cc;">4001</span> <span style="color: #66cc66;">-</span>d postgres <span style="color: #66cc66;">-</span>c <span style="color: #ff0000;">&quot;create table i (x int4)&quot;</span>; psql <span style="color: #66cc66;">-</span>p <span style="color: #cc66cc;">4002</span> <span style="color: #66cc66;">-</span>d postgres <span style="color: #66cc66;">-</span>c <span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\d</span> i'</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span>
       <span style="color: #993333; font-weight: bold;">Table</span> <span style="color: #ff0000;">&quot;public.i&quot;</span>
 <span style="color: #993333; font-weight: bold;">Column</span> <span style="color: #66cc66;">|</span>  <span style="color: #993333; font-weight: bold;">Type</span>   <span style="color: #66cc66;">|</span> Modifiers
<span style="color: #808080; font-style: italic;">--------+---------+-----------</span>
 x      <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span> <span style="color: #66cc66;">|</span></pre></td></tr></table></div>

<p> All looks OK. Now, we can add slave2 and slave3. Since I'm lazy, I will just stop slave, copy slave to slave2/slave3 and then modify them:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ pg_ctl <span style="color: #660033;">-D</span> slave stop
waiting <span style="color: #000000; font-weight: bold;">for</span> server to shut down.... <span style="color: #000000; font-weight: bold;">done</span>
server stopped
&nbsp;
=$ rsync <span style="color: #660033;">-a</span> slave<span style="color: #000000; font-weight: bold;">/</span> slave2<span style="color: #000000; font-weight: bold;">/</span>
&nbsp;
=$ rsync <span style="color: #660033;">-a</span> slave<span style="color: #000000; font-weight: bold;">/</span> slave3<span style="color: #000000; font-weight: bold;">/</span>
&nbsp;
=$ pg_ctl <span style="color: #660033;">-D</span> slave start
server starting</pre></td></tr></table></div>

<p>Slave2 and 3 will be basically the same as slave, but with different port, and connecting to 4002 (slave) instead of 4001 (master) for their WAL. So, let's do the changes:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #c20cb9; font-weight: bold;">perl</span> <span style="color: #660033;">-pi</span> <span style="color: #660033;">-e</span> <span style="color: #ff0000;">'s/port = 4002/port = 4003/'</span> slave2<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">perl</span> <span style="color: #660033;">-pi</span> <span style="color: #660033;">-e</span> <span style="color: #ff0000;">'s/port = 4002/port = 4004/'</span> slave3<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">perl</span> <span style="color: #660033;">-pi</span> <span style="color: #660033;">-e</span> <span style="color: #ff0000;">'s/port=4001/port=4002/'</span> slave<span style="color: #7a0874; font-weight: bold;">&#123;</span><span style="color: #000000;">2</span>,<span style="color: #000000;">3</span><span style="color: #7a0874; font-weight: bold;">&#125;</span><span style="color: #000000; font-weight: bold;">/</span>recovery.conf
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">perl</span> <span style="color: #660033;">-pi</span> <span style="color: #660033;">-e</span> <span style="color: #ff0000;">'s/slave.finish.recovery/slave2.finish.recovery/'</span> slave2<span style="color: #000000; font-weight: bold;">/</span>recovery.conf
&nbsp;
=$ <span style="color: #c20cb9; font-weight: bold;">perl</span> <span style="color: #660033;">-pi</span> <span style="color: #660033;">-e</span> <span style="color: #ff0000;">'s/slave.finish.recovery/slave3.finish.recovery/'</span> slave3<span style="color: #000000; font-weight: bold;">/</span>recovery.conf</pre></td></tr></table></div>

<p>Now we have:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ ack <span style="color: #ff0000;">&quot;^port&quot;</span> <span style="color: #000000; font-weight: bold;">*/</span>postgresql.conf
master<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf
<span style="color: #000000;">63</span>:port = <span style="color: #000000;">4001</span>                          <span style="color: #666666; font-style: italic;"># (change requires restart)</span>
&nbsp;
slave2<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf
<span style="color: #000000;">63</span>:port = <span style="color: #000000;">4003</span>                          <span style="color: #666666; font-style: italic;"># (change requires restart)</span>
&nbsp;
slave3<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf
<span style="color: #000000;">63</span>:port = <span style="color: #000000;">4004</span>                          <span style="color: #666666; font-style: italic;"># (change requires restart)</span>
&nbsp;
slave<span style="color: #000000; font-weight: bold;">/</span>postgresql.conf
<span style="color: #000000;">63</span>:port = <span style="color: #000000;">4002</span>                          <span style="color: #666666; font-style: italic;"># (change requires restart)</span>
&nbsp;
=$ ack port <span style="color: #000000; font-weight: bold;">*/</span>recovery.conf
slave2<span style="color: #000000; font-weight: bold;">/</span>recovery.conf
<span style="color: #000000;">3</span>:primary_conninfo = <span style="color: #ff0000;">'port=4002 user=depesz'</span>
&nbsp;
slave3<span style="color: #000000; font-weight: bold;">/</span>recovery.conf
<span style="color: #000000;">3</span>:primary_conninfo = <span style="color: #ff0000;">'port=4002 user=depesz'</span>
&nbsp;
slave<span style="color: #000000; font-weight: bold;">/</span>recovery.conf
<span style="color: #000000;">3</span>:primary_conninfo = <span style="color: #ff0000;">'port=4001 user=depesz'</span></pre></td></tr></table></div>

<p>So, let's start them:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #000000; font-weight: bold;">for</span> a <span style="color: #000000; font-weight: bold;">in</span> slave2 slave3; <span style="color: #000000; font-weight: bold;">do</span> pg_ctl <span style="color: #660033;">-D</span> <span style="color: #007800;">$a</span><span style="color: #000000; font-weight: bold;">/</span> start; <span style="color: #000000; font-weight: bold;">done</span>
server starting
server starting</pre></td></tr></table></div>

<p>And now we see the processes:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #c20cb9; font-weight: bold;">head</span> <span style="color: #660033;">-n</span> <span style="color: #000000;">1</span> <span style="color: #660033;">-q</span> <span style="color: #000000; font-weight: bold;">*/*</span>.pid <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #660033;">-IPG</span> <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;-p PG --ppid PG&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #c20cb9; font-weight: bold;">ps</span> uwf
USER       PID <span style="color: #000000; font-weight: bold;">%</span>CPU <span style="color: #000000; font-weight: bold;">%</span>MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
depesz   <span style="color: #000000;">14031</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">7496</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> slave3
depesz   <span style="color: #000000;">14032</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">720</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">14033</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66556</span>  <span style="color: #000000;">1400</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: startup process   recovering 000000010000000000000006
depesz   <span style="color: #000000;">14063</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">79456</span>  <span style="color: #000000;">2148</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: wal receiver process   streaming <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>6012ED0
depesz   <span style="color: #000000;">14069</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">1532</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">14070</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">900</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">14026</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66492</span>  <span style="color: #000000;">7496</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> slave2
depesz   <span style="color: #000000;">14042</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26144</span>   <span style="color: #000000;">720</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">14043</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66560</span>  <span style="color: #000000;">1400</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: startup process   recovering 000000010000000000000006
depesz   <span style="color: #000000;">14067</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">79460</span>  <span style="color: #000000;">2148</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: wal receiver process   streaming <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>6012ED0
depesz   <span style="color: #000000;">14071</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66492</span>  <span style="color: #000000;">1532</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">14072</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">900</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">14021</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">7528</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> slave
depesz   <span style="color: #000000;">14037</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">724</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">14038</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66560</span>  <span style="color: #000000;">1572</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: startup process   recovering 000000010000000000000006
depesz   <span style="color: #000000;">14048</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">1536</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">14050</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">904</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">14052</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">79460</span>  <span style="color: #000000;">2136</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: wal receiver process   streaming <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>6012ED0
depesz   <span style="color: #000000;">14064</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67332</span>  <span style="color: #000000;">2476</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: wal sender process depesz <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">local</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> streaming <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>6012ED0
depesz   <span style="color: #000000;">14068</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67452</span>  <span style="color: #000000;">2476</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: wal sender process depesz <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">local</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> streaming <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>6012ED0
depesz   <span style="color: #000000;">12981</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">7524</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> master
depesz   <span style="color: #000000;">12982</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">724</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">12984</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">1780</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">12985</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">1012</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: wal writer process
depesz   <span style="color: #000000;">12986</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67296</span>  <span style="color: #000000;">2156</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: autovacuum launcher process
depesz   <span style="color: #000000;">12987</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">732</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: archiver process
depesz   <span style="color: #000000;">12988</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>  <span style="color: #000000;">1040</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">14053</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67444</span>  <span style="color: #000000;">2520</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: wal sender process depesz <span style="color: #7a0874; font-weight: bold;">&#91;</span><span style="color: #7a0874; font-weight: bold;">local</span><span style="color: #7a0874; font-weight: bold;">&#93;</span> streaming <span style="color: #000000;">0</span><span style="color: #000000; font-weight: bold;">/</span>6012ED0</pre></td></tr></table></div>

<p>Please note that master Pg has only one sender process (pid 14053), slave Pg has receiver (14052) and two senders (14064 and 14068), and slave2 and slave3 have only single receiver (14067 and 14063).</p>
<p>So, now we should test if it all works well, so:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ psql <span style="color: #660033;">-d</span> postgres <span style="color: #660033;">-p</span> <span style="color: #000000;">4001</span> <span style="color: #660033;">-c</span> <span style="color: #ff0000;">'insert into i(x) values (123)'</span>
<span style="color: #000000; font-weight: bold;">for</span> port <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000000;">4002</span> <span style="color: #000000;">4003</span> <span style="color: #000000;">4004</span>
<span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;port=<span style="color: #007800;">$port</span>&quot;</span>
    psql <span style="color: #660033;">-p</span> <span style="color: #007800;">$port</span> <span style="color: #660033;">-d</span> postgres <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;select * from i&quot;</span>
<span style="color: #000000; font-weight: bold;">done</span>
INSERT <span style="color: #000000;">0</span> <span style="color: #000000;">1</span>
<span style="color: #007800;">port</span>=<span style="color: #000000;">4002</span>
 x
<span style="color: #660033;">---</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">0</span> rows<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
<span style="color: #007800;">port</span>=<span style="color: #000000;">4003</span>
 x
<span style="color: #660033;">---</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">0</span> rows<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
<span style="color: #007800;">port</span>=<span style="color: #000000;">4004</span>
 x
<span style="color: #660033;">---</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">0</span> rows<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>The tables are empty. They should have some data, but it might be simply because of replication lag. So let's retry the check, without insert now:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #000000; font-weight: bold;">for</span> port <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #000000;">4002</span> <span style="color: #000000;">4003</span> <span style="color: #000000;">4004</span>
<span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;port=<span style="color: #007800;">$port</span>&quot;</span>
    psql <span style="color: #660033;">-p</span> <span style="color: #007800;">$port</span> <span style="color: #660033;">-d</span> postgres <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;select * from i&quot;</span>
<span style="color: #000000; font-weight: bold;">done</span>
<span style="color: #007800;">port</span>=<span style="color: #000000;">4002</span>
  x
<span style="color: #660033;">-----</span>
 <span style="color: #000000;">123</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span> row<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
<span style="color: #007800;">port</span>=<span style="color: #000000;">4003</span>
  x
<span style="color: #660033;">-----</span>
 <span style="color: #000000;">123</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span> row<span style="color: #7a0874; font-weight: bold;">&#41;</span>
&nbsp;
<span style="color: #007800;">port</span>=<span style="color: #000000;">4004</span>
  x
<span style="color: #660033;">-----</span>
 <span style="color: #000000;">123</span>
<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000;">1</span> row<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre></td></tr></table></div>

<p>And all works fine now. Great.</p>
<p>The only missing feature is ability to make slaves-off-slave still work when slave gets promoted to standalone, but unfortunately, it's not here:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">=$ <span style="color: #c20cb9; font-weight: bold;">touch</span> <span style="color: #000000; font-weight: bold;">/</span>tmp<span style="color: #000000; font-weight: bold;">/</span>slave.finish.recovery; <span style="color: #c20cb9; font-weight: bold;">sleep</span> <span style="color: #000000;">5</span>; <span style="color: #c20cb9; font-weight: bold;">head</span> <span style="color: #660033;">-n</span> <span style="color: #000000;">1</span> <span style="color: #660033;">-q</span> <span style="color: #000000; font-weight: bold;">*/*</span>.pid <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #660033;">-IPG</span> <span style="color: #7a0874; font-weight: bold;">echo</span> <span style="color: #ff0000;">&quot;-p PG --ppid PG&quot;</span> <span style="color: #000000; font-weight: bold;">|</span> <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #c20cb9; font-weight: bold;">ps</span> uwf
USER       PID <span style="color: #000000; font-weight: bold;">%</span>CPU <span style="color: #000000; font-weight: bold;">%</span>MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
depesz   <span style="color: #000000;">14896</span>  <span style="color: #000000;">0.1</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">7524</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> slave3
depesz   <span style="color: #000000;">14897</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">720</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">14898</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66556</span>  <span style="color: #000000;">1696</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: startup process   waiting <span style="color: #000000; font-weight: bold;">for</span> 000000010000000000000006
depesz   <span style="color: #000000;">14901</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">1276</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">14902</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">900</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">14883</span>  <span style="color: #000000;">0.1</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66492</span>  <span style="color: #000000;">7528</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> slave2
depesz   <span style="color: #000000;">14885</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26144</span>   <span style="color: #000000;">724</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">14886</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66560</span>  <span style="color: #000000;">1700</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: startup process   waiting <span style="color: #000000; font-weight: bold;">for</span> 000000010000000000000006
depesz   <span style="color: #000000;">14890</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66492</span>  <span style="color: #000000;">1280</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">14891</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">904</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">18</span>   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">14021</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">7528</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> slave
depesz   <span style="color: #000000;">14037</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">724</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">14048</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">1780</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">14050</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>  <span style="color: #000000;">1032</span> ?        Ss   <span style="color: #000000;">13</span>:03   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process
depesz   <span style="color: #000000;">15018</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66488</span>  <span style="color: #000000;">1016</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">20</span>   <span style="color: #000000;">0</span>:00  \_ postgres: wal writer process
depesz   <span style="color: #000000;">15019</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67320</span>  <span style="color: #000000;">2100</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">20</span>   <span style="color: #000000;">0</span>:00  \_ postgres: autovacuum launcher process
depesz   <span style="color: #000000;">15020</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">912</span> ?        Ss   <span style="color: #000000;">13</span>:<span style="color: #000000;">20</span>   <span style="color: #000000;">0</span>:00  \_ postgres: archiver process   <span style="color: #c20cb9; font-weight: bold;">last</span> was 00000002.history
depesz   <span style="color: #000000;">12981</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">7524</span> pts<span style="color: #000000; font-weight: bold;">/</span><span style="color: #000000;">3</span>    S    <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00 <span style="color: #000000; font-weight: bold;">/</span>home<span style="color: #000000; font-weight: bold;">/</span>pgdba<span style="color: #000000; font-weight: bold;">/</span>work<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>postgres <span style="color: #660033;">-D</span> master
depesz   <span style="color: #000000;">12982</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26140</span>   <span style="color: #000000;">724</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: logger process
depesz   <span style="color: #000000;">12984</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">1780</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: writer process
depesz   <span style="color: #000000;">12985</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">66456</span>  <span style="color: #000000;">1012</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: wal writer process
depesz   <span style="color: #000000;">12986</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">67296</span>  <span style="color: #000000;">2164</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: autovacuum launcher process
depesz   <span style="color: #000000;">12987</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>   <span style="color: #000000;">732</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: archiver process
depesz   <span style="color: #000000;">12988</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">0.0</span>  <span style="color: #000000;">26136</span>  <span style="color: #000000;">1040</span> ?        Ss   <span style="color: #000000;">12</span>:<span style="color: #000000;">50</span>   <span style="color: #000000;">0</span>:00  \_ postgres: stats collector process</pre></td></tr></table></div>

<p>As you can see the sender in slave got killed, and thus slave2 and slave3 are still slaves, but without source of WAL.</p>
<p>Logs of slave2 and slave3 PostgreSQL show clear reason why it doesn't work:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">2011-07-26 13:26:41.483 CEST    16318: FATAL:  timeline 2 of the primary does not match recovery target timeline 1</pre></td></tr></table></div>

<p>Clearly &#8211; slave is using timeline == 2, while slave2 and slave3 are still on timeline == 1.</p>
<p>Theoretically it should be simple to fix, since slave has pg_xlog/00000002.history file, but the functionality to switch timelines in recovery is simply not there yet.</p>
<p>Anyway &#8211; ability to have slaves that are receiving WAL from other slaves, is pretty cool, and definitely a welcome addition.</p>
<p><!-- vim: set spell spelllang=en_US ft=xhtml: --></p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">One comment <a href='http://www.depesz.com/2011/07/26/waiting-for-9-2-cascading-streaming-replication/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-34016" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-34016" title="">#</a></span> ioguix</div>  <div class="date">Jul 28, 2011</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/5edb659a3e3b2651d2343d6c61dec81b?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Hey,</p>
<p>I did discuss the &#8220;swithing timeline&#8221; issue with Masao-san during last pgcon. I&#8217;m not sure, but I think you just cannot switch timeline using streaming replication, but you can do it from archives.</p>
<p>Maybe you can setup log shipping from slave1 to slave2 and 3, and add in the recovery.conf:<br />
  recovery_target_timeline = &#8216;latest&#8217;</p>
<p>Then restart slave2 and 3 after the slave1 promotion.</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2268" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="a87e8e1f34" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="9"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">3 comments</span> | <span class="wpp-views">587 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">364 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">252 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">192 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">147 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">132 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">118 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">116 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">116 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/11/14/how-i-learned-to-stop-worrying-and-love-the-triggers/" title="How I Learned to Stop Worrying and Love the Triggers" class="wpp-post-title" target="_self">How I Learned to Stop Worrying and Love the Triggers</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">97 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochd</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

