http://www.depesz.com/2012/12/09/cute-overload/
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 24 Jul 2014 12:17:49 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2576>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; CuTE overload</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; CuTE overload Comments Feed" href="http://www.depesz.com/2012/12/09/cute-overload/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2012/12/09/cute-overload/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2576' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2576">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2012/12/09/cute-overload/" rel="bookmark" title="Permanent Link to CuTE overload">CuTE overload</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>December 9th, 2012 by depesz | Tags: <a href="http://www.depesz.com/tag/cte/" rel="tag">cte</a>, <a href="http://www.depesz.com/tag/cute/" rel="tag">cute</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/primer/" rel="tag">primer</a>, <a href="http://www.depesz.com/tag/recursive/" rel="tag">recursive</a>, <a href="http://www.depesz.com/tag/wcte/" rel="tag">wcte</a>, <a href="http://www.depesz.com/tag/with/" rel="tag">with</a>, <a href="http://www.depesz.com/tag/with-recursive/" rel="tag">with recursive</a> |  <a href="http://www.depesz.com/2012/12/09/cute-overload/#comments" title="Comment on CuTE overload">1 comment &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p><a href="http://cuteoverload.com/2008/04/03/im-crawling-up/"><img src="/wp-content/uploads/2012/12/kitten600.jpg" width="550" height="320" alt="[ CuTE kitten ]"/></a></p>
<p>In PostgreSQL 8.4 we got <a href="http://www.depesz.com/2008/10/07/waiting-for-84-common-table-expressions-with-queries/">CTE</a> &#8211; Common Table Expressions. Since then we have this great tool available, but apparently for some people it's still black magic. CuTE, but still magic. I'll try to make it a bit less magical, and more understandable.</p>
<p><span id="more-2576"></span></p>
<p>The very basic way you can use CTE, is with query like:</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">with</span> base_info <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span>
        oid::regclass <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">table_name</span><span style="color: #66cc66;">,</span> pg_table_size<span style="color: #66cc66;">&#40;</span>oid<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">size</span>
    <span style="color: #993333; font-weight: bold;">from</span>
        pg_class
    <span style="color: #993333; font-weight: bold;">where</span>
        relkind <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'r'</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span>
<span style="color: #993333; font-weight: bold;">FROM</span> base_info
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">size</span> <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">10</span>;</pre></td></tr></table></div>

<p>Result of the query looks like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">  <span style="color: #993333; font-weight: bold;">table_name</span>   <span style="color: #66cc66;">|</span>  <span style="color: #993333; font-weight: bold;">size</span>
<span style="color: #808080; font-style: italic;">----------------+--------</span>
 pg_proc        <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">548864</span>
 pg_rewrite     <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">507904</span>
 pg_depend      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">417792</span>
 test           <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">393216</span>
 pg_attribute   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">376832</span>
 pg_description <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">286720</span>
 pg_statistic   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">221184</span>
 pg_operator    <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">147456</span>
 pg_class       <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">98304</span>
 pg_type        <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">98304</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Let's analyze what's inside the query.</p>
<ul>
<li>Line #1 &#8211; starts with word &#8220;WITH" &#8211; this is the tell-tale sign of CTEs. Every query that uses them has to start using WITH</li>
<li>Still line #1 &#8211; &#8220;base_info" &#8211; name of the CTE that will be defined after &#8220;as", and within parentheses. Any name is acceptable &#8211; basically it is just like table or view name</li>
<li>Lines 2-7 &#8211; definition of the CTE. This is a query, that can return any number of rows &#8211; you can think of it as inlined VIEW (though there are differences)</li>
<li>Line 8 &#8211; parentheses finishing current CTE. We could have more than one in given query, using syntax like: <em>with a as (&#8230;), b as (&#8230;), c as (&#8230;)</em>, but for now single CTE is enough</li>
<li>Lines 9-11 &#8211; actual query, that is using the CTE just as it would any table/view &#8211; just providing its name in FROM clause.</li>
</ul>
<p>Hope that's not scary.</p>
<p>Now you could ask: well, OK. But what is the point of using CTE when you can simply have VIEWs?</p>
<p>Answer has two elements. First &#8211; because it can be simpler. Instead of going the whole route of think about view, create it, grant privileges, and so on &#8211; you just embed the view in your query, and you're done.</p>
<p>But the other, much more important (in my opinion) thing is that CTEs, unlike VIEWs, are treated as separate entities, and behave like &#8220;optimization wall".</p>
<p>What wall? Let me show you simple example:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">DROP</span> <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">exists</span> test;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> test <span style="color: #66cc66;">&#40;</span> id INT4 <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">,</span> some_val INT4 <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span><span style="color: #66cc66;">&#41;</span>;
&nbsp;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> test <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">,</span> some_val<span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> i<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">case</span> <span style="color: #993333; font-weight: bold;">when</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">0.5</span> <span style="color: #993333; font-weight: bold;">THEN</span> <span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">ELSE</span> <span style="color: #cc66cc;">2</span> <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">FROM</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">1000</span><span style="color: #66cc66;">&#41;</span> i;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> test <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">,</span> some_val<span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> i<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">cast</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">2</span> <span style="color: #66cc66;">+</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">100</span> <span style="color: #993333; font-weight: bold;">as</span> INT4<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">FROM</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1001</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">10000</span><span style="color: #66cc66;">&#41;</span> i;
&nbsp;
<span style="color: #993333; font-weight: bold;">ALTER</span> <span style="color: #993333; font-weight: bold;">TABLE</span> test <span style="color: #993333; font-weight: bold;">add</span> <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span> i1 <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #66cc66;">&#40;</span>some_val<span style="color: #66cc66;">&#41;</span>;
analyze test;</pre></td></tr></table></div>

<p>This is relatively simple table, with 10000 rows. Each row has 2 columns: id &#8211; primary key, integer from 1 to 10000, and some_val, which is <em>basically</em> random.</p>
<p>What do I mean by &#8220;basically". Well, the values range from 1 to 102, but values 1 and 2 are much more common (~ 5 times as common), but 1 happens only in the first 1000 records.</p>
<p>Now, let's see simple query that is looking for some_val = 1:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> test <span style="color: #993333; font-weight: bold;">WHERE</span> some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span>;
                                                   QUERY PLAN
<span style="color: #808080; font-style: italic;">----------------------------------------------------------------------------------------------------------------</span>
 Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">11.97</span><span style="color: #66cc66;">..</span>62<span style="color: #66cc66;">.</span>94 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.113</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>208 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   Recheck Cond: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>11<span style="color: #66cc66;">.</span>85 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.089</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>089 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">0.286</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Works OK &#8211; it did use index on some_val column, fetched all rows (478 of them).</p>
<p>What would happen if I'd want just 5 newest rows with some_val = 1?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> test <span style="color: #993333; font-weight: bold;">WHERE</span> some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> id <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">5</span>;
                                                            QUERY PLAN
<span style="color: #808080; font-style: italic;">-----------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #993333; font-weight: bold;">Limit</span>  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>3<span style="color: #66cc66;">.</span>59 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">3.117</span><span style="color: #66cc66;">..</span>3<span style="color: #66cc66;">.</span>121 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Index</span> Scan Backward <span style="color: #993333; font-weight: bold;">using</span> test_pkey <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>343<span style="color: #66cc66;">.</span>26 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">3.115</span><span style="color: #66cc66;">..</span>3<span style="color: #66cc66;">.</span>117 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">9001</span>
 Total runtime: <span style="color: #cc66cc;">3.163</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Please note that planner did something rather stupid in here: instead of getting 478 rows that match where condition, it instead scanned almost whole table, discarded first found 9001 rows, and then, finally, found 5 newest rows with some_val = 1.</p>
<p>( side note: this example is one of the reasons I'm firm believer that we should have planner HINTs, despite all the opposition from some developers )</p>
<p>Why did it happen? Well, without going into too much detail &#8211; PostgreSQL assumed some things that are not true, and ran the query as if they were. So it was slower than it could be.</p>
<p>Let's see how I can make PostgreSQL behave if I'll use CTE optimization barrier to fight stupid decisions:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">WITH</span> i_know_what_im_doing <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> test
    <span style="color: #993333; font-weight: bold;">WHERE</span> some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span>
<span style="color: #993333; font-weight: bold;">FROM</span> i_know_what_im_doing
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> id <span style="color: #993333; font-weight: bold;">DESC</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">5</span>;
                                                          QUERY PLAN
<span style="color: #808080; font-style: italic;">------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #993333; font-weight: bold;">Limit</span>  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">80.44</span><span style="color: #66cc66;">..</span>80<span style="color: #66cc66;">.</span>45 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.526</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>527 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   CTE i_know_what_im_doing
     <span style="color: #66cc66;">-&gt;</span>  Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">11.97</span><span style="color: #66cc66;">..</span>62<span style="color: #66cc66;">.</span>94 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.101</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>206 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
           Recheck Cond: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
           <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>11<span style="color: #66cc66;">.</span>85 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.080</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>080 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
                 <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Sort  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">17.50</span><span style="color: #66cc66;">..</span>18<span style="color: #66cc66;">.</span>69 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.523</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>523 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         Sort <span style="color: #993333; font-weight: bold;">Key</span>: i_know_what_im_doing<span style="color: #66cc66;">.</span>id
         Sort Method: top<span style="color: #66cc66;">-</span>N heapsort  Memory: 25kB
         <span style="color: #66cc66;">-&gt;</span>  CTE Scan <span style="color: #993333; font-weight: bold;">on</span> i_know_what_im_doing  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>9<span style="color: #66cc66;">.</span>56 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.106</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>360 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">0.596</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">11</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Now. Please note that PostgreSQL did use i1 index, to find matching rows. Afterwards, these rows were sorted using normal top-N heapsort. It's faster.</p>
<p>How would a view work in here?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">view</span> im_lost <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> test <span style="color: #993333; font-weight: bold;">WHERE</span> some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span>;
&nbsp;
<span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span>
<span style="color: #993333; font-weight: bold;">FROM</span> im_lost
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> id <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">5</span>;
                                                            QUERY PLAN
<span style="color: #808080; font-style: italic;">-----------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #993333; font-weight: bold;">Limit</span>  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>3<span style="color: #66cc66;">.</span>59 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2.946</span><span style="color: #66cc66;">..</span>2<span style="color: #66cc66;">.</span>948 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Index</span> Scan Backward <span style="color: #993333; font-weight: bold;">using</span> test_pkey <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>343<span style="color: #66cc66;">.</span>26 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">478</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2.943</span><span style="color: #66cc66;">..</span>2<span style="color: #66cc66;">.</span>945 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">9001</span>
 Total runtime: <span style="color: #cc66cc;">2.997</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>As you can see &#8211; adding view made Pg use bad plan. That's because views are internally rewrite rules.</p>
<p>Another benefit is that CTE data is calculated once.</p>
<p>What does it mean?</p>
<p>Let's make a test function that takes <b>long</b> time to calculate something. In our case it will &#8220;calculate" random number, in range 0-1000:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">function</span> hard_work<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">returns</span> int4 <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">begin</span>
    perform pg_sleep<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">0.1</span><span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">return</span> <span style="color: #993333; font-weight: bold;">floor</span><span style="color: #66cc66;">&#40;</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">1000</span> <span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">end</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;</pre></td></tr></table></div>

<p>Of course this function doesn't make any sense, it's just here to show you, in simple, numeric, way some facts.</p>
<p>Now, let's assume that we want to call it 10 times:</p>
<p>select hard_work() from generate_series(1,10);</p>
<p>But, let's assume we don't know what it returns, so we also want to get sum of the values it did return.</p>
<p>Let's start with a view approach:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">view</span> lots_of_work <span style="color: #993333; font-weight: bold;">as</span>
    <span style="color: #993333; font-weight: bold;">select</span> hard_work<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> h <span style="color: #993333; font-weight: bold;">from</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>Now, I can write simple query:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>h<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> lots_of_work<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #993333; font-weight: bold;">from</span> lots_of_work;
  h  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #808080; font-style: italic;">-----+------</span>
 <span style="color: #cc66cc;">519</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">729</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">140</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">945</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
  <span style="color: #cc66cc;">69</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">765</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">179</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">751</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">714</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
 <span style="color: #cc66cc;">462</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4111</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">2007.982</span> ms</pre></td></tr></table></div>

<p>Before I will analyze it, let's see how it works in case of CTE:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">WITH</span> less_work <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> hard_work<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> h <span style="color: #993333; font-weight: bold;">from</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    h<span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>h<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> less_work<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #993333; font-weight: bold;">FROM</span> less_work;
  h  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #808080; font-style: italic;">-----+------</span>
 <span style="color: #cc66cc;">319</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
  <span style="color: #cc66cc;">43</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
  <span style="color: #cc66cc;">26</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
 <span style="color: #cc66cc;">484</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
 <span style="color: #cc66cc;">455</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
  <span style="color: #cc66cc;">75</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
 <span style="color: #cc66cc;">473</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
  <span style="color: #cc66cc;">69</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
 <span style="color: #cc66cc;">851</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
 <span style="color: #cc66cc;">715</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3510</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">1005.168</span> ms</pre></td></tr></table></div>

<p>Values are of course different, but the point is different. First of all &#8211; please notice that the runtime of CTE version is half of VIEW version.</p>
<p>And also &#8211; please note that while sum in case of CTE is correct ( 319 + 43 + 26 + 484 + 455 + 75 + 473 + 69 + 851 + 715 = 3510 ), in case of VIEW &#8211; the sum is incorrect ( 519 + 729 + 140 + 945 + 69 + 765 + 179 + 751 + 714 + 462 = 5273 ).</p>
<p>Why is that so? Very simple &#8211; view rewrites the query, and CTE is &#8220;materialized". And this means that in VIEW version our slow function has to be called 20 times (10 times to return records, and 10 times to be used for summing of return values). In case of CTE &#8211; function is called 10 times, and the returned values are available to reuse for summing.</p>
<p>This can be seen in these explain analyze plans:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>h<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> lots_of_work<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #993333; font-weight: bold;">from</span> lots_of_work;
                                                                       QUERY PLAN
<span style="color: #808080; font-style: italic;">---------------------------------------------------------------------------------------------------------------------------------------------------------</span>
 Subquery Scan <span style="color: #993333; font-weight: bold;">on</span> lots_of_work  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">272.51</span><span style="color: #66cc66;">..</span>542<span style="color: #66cc66;">.</span>51 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1104.304</span><span style="color: #66cc66;">..</span>2006<span style="color: #66cc66;">.</span>659 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   InitPlan <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">returns</span> $0<span style="color: #66cc66;">&#41;</span>
     <span style="color: #66cc66;">-&gt;</span>  Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">272.50</span><span style="color: #66cc66;">..</span>272<span style="color: #66cc66;">.</span>51 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1002.646</span><span style="color: #66cc66;">..</span>1002<span style="color: #66cc66;">.</span>646 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
           <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Function</span> Scan <span style="color: #993333; font-weight: bold;">on</span> generate_series generate_series_1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>260<span style="color: #66cc66;">.</span>00 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">100.268</span><span style="color: #66cc66;">..</span>1002<span style="color: #66cc66;">.</span>633 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Function</span> Scan <span style="color: #993333; font-weight: bold;">on</span> generate_series  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>260<span style="color: #66cc66;">.</span>00 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">101.654</span><span style="color: #66cc66;">..</span>1004<span style="color: #66cc66;">.</span>003 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">2006.778</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">6</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>You can see now that there are two separate calls to generate_series(). With CTE, just one:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">WITH</span> less_work <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> hard_work<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> h <span style="color: #993333; font-weight: bold;">from</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    h<span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>h<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> less_work<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #993333; font-weight: bold;">FROM</span> less_work;
                                                             QUERY PLAN
<span style="color: #808080; font-style: italic;">------------------------------------------------------------------------------------------------------------------------------------</span>
 CTE Scan <span style="color: #993333; font-weight: bold;">on</span> less_work  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">282.51</span><span style="color: #66cc66;">..</span>302<span style="color: #66cc66;">.</span>51 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1004.037</span><span style="color: #66cc66;">..</span>1004<span style="color: #66cc66;">.</span>041 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   CTE less_work
     <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Function</span> Scan <span style="color: #993333; font-weight: bold;">on</span> generate_series  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>260<span style="color: #66cc66;">.</span>00 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">101.640</span><span style="color: #66cc66;">..</span>1003<span style="color: #66cc66;">.</span>990 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   InitPlan <span style="color: #cc66cc;">2</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">returns</span> $1<span style="color: #66cc66;">&#41;</span>
     <span style="color: #66cc66;">-&gt;</span>  Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">22.50</span><span style="color: #66cc66;">..</span>22<span style="color: #66cc66;">.</span>51 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">902.390</span><span style="color: #66cc66;">..</span>902<span style="color: #66cc66;">.</span>390 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
           <span style="color: #66cc66;">-&gt;</span>  CTE Scan <span style="color: #993333; font-weight: bold;">on</span> less_work less_work_1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>20<span style="color: #66cc66;">.</span>00 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.001</span><span style="color: #66cc66;">..</span>902<span style="color: #66cc66;">.</span>377 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">1004.142</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">7</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Does that mean that you should use CTE always and never views. Well, no.</p>
<p>Let's see how many rows there are for every some_val in our temp table. First, I'll do it by defining a view:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">view</span> smart_view <span style="color: #993333; font-weight: bold;">as</span>
    <span style="color: #993333; font-weight: bold;">select</span> some_val<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> some_val;</pre></td></tr></table></div>

<p>and afterwards, I can use it in a query:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> smart_view <span style="color: #993333; font-weight: bold;">where</span> some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">3</span>;
                                                    QUERY PLAN
<span style="color: #808080; font-style: italic;">-------------------------------------------------------------------------------------------------------------------</span>
 GroupAggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4.94</span><span style="color: #66cc66;">..</span>51<span style="color: #66cc66;">.</span>49 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.288</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>288 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4.94</span><span style="color: #66cc66;">..</span>51<span style="color: #66cc66;">.</span>04 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">88</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.132</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>271 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">81</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         Recheck Cond: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">3</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>4<span style="color: #66cc66;">.</span>92 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">88</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.116</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>116 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">81</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
               <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">3</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">0.396</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">6</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Now, let's see how it would work with view definition as CTE:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">WITH</span> not_so_smart_cte <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> some_val<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> test
    <span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span> some_val
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span>
<span style="color: #993333; font-weight: bold;">FROM</span> not_so_smart_cte
<span style="color: #993333; font-weight: bold;">WHERE</span> some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">3</span>;
                                                      QUERY PLAN
<span style="color: #808080; font-style: italic;">----------------------------------------------------------------------------------------------------------------------</span>
 CTE Scan <span style="color: #993333; font-weight: bold;">on</span> not_so_smart_cte  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">196.02</span><span style="color: #66cc66;">..</span>198<span style="color: #66cc66;">.</span>31 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">6.165</span><span style="color: #66cc66;">..</span>6<span style="color: #66cc66;">.</span>232 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span>some_val <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">3</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">101</span>
   CTE not_so_smart_cte
     <span style="color: #66cc66;">-&gt;</span>  HashAggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">195.00</span><span style="color: #66cc66;">..</span>196<span style="color: #66cc66;">.</span>02 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">102</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">6.145</span><span style="color: #66cc66;">..</span>6<span style="color: #66cc66;">.</span>164 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">102</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
           <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>145<span style="color: #66cc66;">.</span>00 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10000</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.014</span><span style="color: #66cc66;">..</span>1<span style="color: #66cc66;">.</span>827 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10000</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">6.334</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">7</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>The difference should be clearly visible &#8211; view approach was able to use the &#8220;some_val = 3&#8243; condition to fetch less rows from table, and then count just them.</p>
<p>CTE approach is different &#8211; first it takes all records (rows=10000), then it aggregates it, and then, from the aggregate takes single row.</p>
<p>As you can see &#8211; there is no silver bullet. There are cases where CTEs are better, and there are cases when CTEs are worse. I like to use them, because it lets me write my query in a sort of &#8220;block-by-block" way. Like: first, I need some rows from here, so I'll build CTE that does it. Then, based on these rows I need something else, so I add another CTE, and so on.</p>
<p>All I have written up to now is about simple CTEs &#8211; just a &#8220;views in disguise". But CTEs have one big trick up their sleeve: recursive cuteness.</p>
<p>We all know that to understand recursion you have to first understand recursion. How can I explain it, then?</p>
<p>First, let's see some simple recursive CTE query:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">with</span> recursive i <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">as</span> x
    <span style="color: #993333; font-weight: bold;">union</span> <span style="color: #993333; font-weight: bold;">all</span>
    <span style="color: #993333; font-weight: bold;">select</span> x<span style="color: #66cc66;">+</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">from</span> i <span style="color: #993333; font-weight: bold;">where</span> x <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">10</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> i;
 x
<span style="color: #808080; font-style: italic;">----</span>
  <span style="color: #cc66cc;">1</span>
  <span style="color: #cc66cc;">2</span>
  <span style="color: #cc66cc;">3</span>
  <span style="color: #cc66cc;">4</span>
  <span style="color: #cc66cc;">5</span>
  <span style="color: #cc66cc;">6</span>
  <span style="color: #cc66cc;">7</span>
  <span style="color: #cc66cc;">8</span>
  <span style="color: #cc66cc;">9</span>
 <span style="color: #cc66cc;">10</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>That's it. The key things to see/understand:</p>
<ul>
<li>recursive CTE needs to be marked using &#8220;WITH RECURSIVE"</li>
<li>recursive CTE consists of two queries joined with UNION or UNION ALL. In my case it is &#8220;SELECT 1 as x" and &#8220;SELECT x+1 FROM i WHERE x &lt; 10</li>
</ul>
<p>You might ask: what if I have multiple CTEs in single query, and one of them, and not the first one, is recursive, while others are not? It's simple &#8211; as long as any of the CTEs are recursive, you have to use &#8220;WITH RECURSIVE".</p>
<p>Let's get a bit more complicated query, so we can see what's happening and how.</p>
<p>For my tests, I will be using copy of <a href="http://dmoz.org/">DMOZ</a> category structure that I downloaded long time ago. You can get the data in sql-dump format from <a href="/wp-content/uploads/2012/12/dmoz.table.sql.gz">here</a> so you can follow with my examples.</p>
<p>To have rather small, but interesting sample data, I chose these categories:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>                         label
<span style="color: #808080; font-style: italic;">-------+-----------+--------------------------------------------------------</span>
 <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92960</span> <span style="color: #66cc66;">|</span> Turkey
 <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bilkent_University
 <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bogazici_University
 <span style="color: #cc66cc;">93001</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Middle_East_Technical_University
 <span style="color: #cc66cc;">92989</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span> Departments
 <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Faculties
 <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Institutes
 <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Schools
 <span style="color: #cc66cc;">92992</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Arts_and_Sciences
 <span style="color: #cc66cc;">92993</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Economics_and_Administrative_Sciences
 <span style="color: #cc66cc;">92994</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Education
 <span style="color: #cc66cc;">92995</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Engineering
 <span style="color: #cc66cc;">92997</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span> Kandilli_Observatory_Earthquake_and_Research_Institute
 <span style="color: #cc66cc;">92999</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Applied_Disciplines
 <span style="color: #cc66cc;">93000</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Foreign_Languages
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>When you'll create paths, based on id/parent_id relations, you'll get:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>                                             path
<span style="color: #808080; font-style: italic;">-------+-----------+----------------------------------------------------------------------------------------------</span>
 <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92960</span> <span style="color: #66cc66;">|</span> Turkey
 <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bilkent_University
 <span style="color: #cc66cc;">92989</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bilkent_University<span style="color: #66cc66;">/</span>Departments
 <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University
 <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Faculties
 <span style="color: #cc66cc;">92992</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Faculties<span style="color: #66cc66;">/</span>Arts_and_Sciences
 <span style="color: #cc66cc;">92993</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Faculties<span style="color: #66cc66;">/</span>Economics_and_Administrative_Sciences
 <span style="color: #cc66cc;">92994</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Faculties<span style="color: #66cc66;">/</span>Education
 <span style="color: #cc66cc;">92995</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Faculties<span style="color: #66cc66;">/</span>Engineering
 <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Institutes
 <span style="color: #cc66cc;">92997</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Institutes<span style="color: #66cc66;">/</span>Kandilli_Observatory_Earthquake_and_Research_Institute
 <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Schools
 <span style="color: #cc66cc;">92999</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Schools<span style="color: #66cc66;">/</span>Applied_Disciplines
 <span style="color: #cc66cc;">93000</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Bogazici_University<span style="color: #66cc66;">/</span>Schools<span style="color: #66cc66;">/</span>Foreign_Languages
 <span style="color: #cc66cc;">93001</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Turkey<span style="color: #66cc66;">/</span>Middle_East_Technical_University
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>The exercise is to get all kids for id = 92987 using recursive CTE.</p>
<p>We start by getting first element &#8211; the one that will be start of our recursion. So, clearly it should be:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>;
  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span> label
<span style="color: #808080; font-style: italic;">-------+-----------+--------</span>
 <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92960</span> <span style="color: #66cc66;">|</span> Turkey
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>So far, so good. Now, we need to add kids. First, think about just getting direct subcategories, which can be done obviously with:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> parent_id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>;
  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>              label
<span style="color: #808080; font-style: italic;">-------+-----------+----------------------------------</span>
 <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bilkent_University
 <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bogazici_University
 <span style="color: #cc66cc;">93001</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Middle_East_Technical_University
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">3</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>So far, so good. We could then continue, without using CTE, by doing something like:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> parent_id <span style="color: #993333; font-weight: bold;">IN</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> id <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> parent_id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>
<span style="color: #66cc66;">&#41;</span>;
  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>    label
<span style="color: #808080; font-style: italic;">-------+-----------+-------------</span>
 <span style="color: #cc66cc;">92989</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span> Departments
 <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Faculties
 <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Institutes
 <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Schools
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">4</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>But this gets tedious pretty soon. And, there is also another problem. Let's assume you write the above 3 queries as one, using UNION ALL:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>
<span style="color: #993333; font-weight: bold;">UNION</span> <span style="color: #993333; font-weight: bold;">ALL</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> parent_id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>
<span style="color: #993333; font-weight: bold;">UNION</span> <span style="color: #993333; font-weight: bold;">ALL</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> parent_id <span style="color: #993333; font-weight: bold;">IN</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> id <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> parent_id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>
<span style="color: #66cc66;">&#41;</span>;
  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>              label
<span style="color: #808080; font-style: italic;">-------+-----------+----------------------------------</span>
 <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92960</span> <span style="color: #66cc66;">|</span> Turkey
 <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bilkent_University
 <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bogazici_University
 <span style="color: #cc66cc;">93001</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Middle_East_Technical_University
 <span style="color: #cc66cc;">92989</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span> Departments
 <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Faculties
 <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Institutes
 <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Schools
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">8</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Of course, it works, but please note that we would have to add another query just to get 4 levels that we need in our case, but technically &#8211; we should be adding much more queries if we didn't know how deep the structure goes.</p>
<p>Recursive CTE is great solution, because You can rewrite potentially infinite query (UNION-ALL style, like above) to something <em>way</em> simpler:</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">WITH</span> RECURSIVE all_kids <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>
    <span style="color: #993333; font-weight: bold;">UNION</span> <span style="color: #993333; font-weight: bold;">ALL</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> d<span style="color: #66cc66;">.*</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> dmoz d
        <span style="color: #993333; font-weight: bold;">JOIN</span> all_kids ak <span style="color: #993333; font-weight: bold;">on</span> d<span style="color: #66cc66;">.</span>parent_id <span style="color: #66cc66;">=</span> ak<span style="color: #66cc66;">.</span>id
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">FROM</span> all_kids;
  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>                         label
<span style="color: #808080; font-style: italic;">-------+-----------+--------------------------------------------------------</span>
 <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92960</span> <span style="color: #66cc66;">|</span> Turkey
 <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bilkent_University
 <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bogazici_University
 <span style="color: #cc66cc;">93001</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Middle_East_Technical_University
 <span style="color: #cc66cc;">92989</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span> Departments
 <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Faculties
 <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Institutes
 <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Schools
 <span style="color: #cc66cc;">92992</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Arts_and_Sciences
 <span style="color: #cc66cc;">92993</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Economics_and_Administrative_Sciences
 <span style="color: #cc66cc;">92994</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Education
 <span style="color: #cc66cc;">92995</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Engineering
 <span style="color: #cc66cc;">92997</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span> Kandilli_Observatory_Earthquake_and_Research_Institute
 <span style="color: #cc66cc;">92999</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Applied_Disciplines
 <span style="color: #cc66cc;">93000</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Foreign_Languages
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>That was fast. In writing at least <img src="http://www.depesz.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> </p>
<p>Let's see how it works:</p>
<ul>
<li>Line #1 &#8211; marks that we will be doing some recursion (WITH RECURSIVE), and starts &#8220;all_kids" cte.</li>
<li>Line #2 &#8211; it's the initial row for recursion &#8211; the row that we know how to get by id</li>
<li>Line #3 &#8211; UNION ALL &#8211; all recursive queries, as I said &#8211; as two queries with UNION or UNION ALL in between</li>
<li>Lines #4-#5 &#8211; we will be returning all columns from table dmoz</li>
<li>Line #6 &#8211; rows to return should have parent_id that is listed in all_kids cte</li>
<li>Line #7 &#8211; ends the CTE</li>
<li>Line #8 &#8211; returns rows from all_kids</li>
</ul>
<p>You might wonder &#8211; well, but on first loop &#8211; the 2nd query (after UNION ALL), will be equivalent to: select * from dmoz where parent_id = 92987, because that's the only row there. What happens on subsequent rows, though?  Which rows are taken into consideration? Of course new ones (with ids 92989, 92991, 92996, 92998, but is 92987 (top level) still taken into consideration)? No. On each run only newly added rows are &#8220;visible" to recursive part. We can see it by adding simple window function:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">WITH</span> RECURSIVE all_kids <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*,</span> <span style="color: #ff0000;">'{}'</span>::int4<span style="color: #66cc66;">&#91;</span><span style="color: #66cc66;">&#93;</span> <span style="color: #993333; font-weight: bold;">as</span> parents <span style="color: #993333; font-weight: bold;">FROM</span> dmoz <span style="color: #993333; font-weight: bold;">WHERE</span> id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">92987</span>
    <span style="color: #993333; font-weight: bold;">UNION</span> <span style="color: #993333; font-weight: bold;">ALL</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> d<span style="color: #66cc66;">.*,</span> array_agg<span style="color: #66cc66;">&#40;</span>ak<span style="color: #66cc66;">.</span>id<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> dmoz d
        <span style="color: #993333; font-weight: bold;">JOIN</span> all_kids ak <span style="color: #993333; font-weight: bold;">on</span> d<span style="color: #66cc66;">.</span>parent_id <span style="color: #66cc66;">=</span> ak<span style="color: #66cc66;">.</span>id
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">select</span>
    id<span style="color: #66cc66;">,</span>
    parent_id<span style="color: #66cc66;">,</span>
    label<span style="color: #66cc66;">,</span>
    array<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">distinct</span> unnest<span style="color: #66cc66;">&#40;</span> parents <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> parents
<span style="color: #993333; font-weight: bold;">from</span>
all_kids;
  id   <span style="color: #66cc66;">|</span> parent_id <span style="color: #66cc66;">|</span>                         label                          <span style="color: #66cc66;">|</span>       parents
<span style="color: #808080; font-style: italic;">-------+-----------+--------------------------------------------------------+---------------------</span>
 <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92960</span> <span style="color: #66cc66;">|</span> Turkey                                                 <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bilkent_University                                     <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92987</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Bogazici_University                                    <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92987</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">93001</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92987</span> <span style="color: #66cc66;">|</span> Middle_East_Technical_University                       <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92987</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92989</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92988</span> <span style="color: #66cc66;">|</span> Departments                                            <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92988</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92990</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Faculties                                              <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92988</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92990</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Institutes                                             <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92988</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92990</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92990</span> <span style="color: #66cc66;">|</span> Schools                                                <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92988</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92990</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92992</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Arts_and_Sciences                                      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92993</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Economics_and_Administrative_Sciences                  <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92994</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Education                                              <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92995</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92991</span> <span style="color: #66cc66;">|</span> Engineering                                            <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92997</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92996</span> <span style="color: #66cc66;">|</span> Kandilli_Observatory_Earthquake_and_Research_Institute <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">92999</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Applied_Disciplines                                    <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
 <span style="color: #cc66cc;">93000</span> <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">92998</span> <span style="color: #66cc66;">|</span> Foreign_Languages                                      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #cc66cc;">92998</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92996</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">92991</span><span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">15</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>(The additional logic is adding array_agg() in CTE, and then array() call to make the list of parents distinct)</p>
<p>As you can see, each subsequent recurrence is seeing in all_kids just the rows that were added there by previous run.</p>
<p>Of course recursive CTE is not limited to working on trees. It can be used to do many things &#8211; solving <a href="http://www.depesz.com/2012/06/25/how-to-get-shortest-connection-between-two-cities/">travelling salesman problem</a>, finding <a href="http://www.depesz.com/2011/04/27/find-cheapest-combination-of-rooms-in-hotels/">cheap</a> and many others.</p>
<p>Finally, since 9.1 we have <a href="http://www.depesz.com/2011/03/16/waiting-for-9-1-writable-cte/">writable CTE</a>. This is basically normal CTE, but where source of rows is not SELECT clause, but rather some write operation (INSERT, UPDATE, DELETE) with RETURNING clause.</p>
<p>This is rather simple, we can do stuff like:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">with</span> ids_to_delete <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> id <span style="color: #993333; font-weight: bold;">from</span> dmoz <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> id <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">5</span>
<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> delete_it <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">delete</span> <span style="color: #993333; font-weight: bold;">from</span> dmoz <span style="color: #993333; font-weight: bold;">where</span> id <span style="color: #993333; font-weight: bold;">in</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">select</span> id <span style="color: #993333; font-weight: bold;">from</span> ids_to_delete <span style="color: #66cc66;">&#41;</span> returning <span style="color: #66cc66;">*</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">select</span> string_agg<span style="color: #66cc66;">&#40;</span>label<span style="color: #66cc66;">,</span> <span style="color: #ff0000;">', '</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> delete_it;
                        string_agg
<span style="color: #808080; font-style: italic;">----------------------------------------------------------</span>
 Vietnamese<span style="color: #66cc66;">,</span> Vinodam<span style="color: #66cc66;">,</span> Ukrainian<span style="color: #66cc66;">,</span> Vaarthaa_Patrikalu<span style="color: #66cc66;">,</span> Thai
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>In here, I used first normal CTE (ids_to_delete) to get some ids of rows to delete, then I used delete_it as writable cte &#8211; that is &#8211; it did remove the rows, and delete_it CTE contained deleted rows. And finally &#8211; I got labels of all deleted rows as single column.</p>
<p>I hope this will make this CuTE feature of PostgreSQL simpler to understand and use. As always &#8211; if anything is not clear, please let me know so I can fix it.</p>
<p><!-- vim: set spell spelllang=en_US ft=xhtml: --></p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">One comment <a href='http://www.depesz.com/2012/12/09/cute-overload/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-36680" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-36680" title="">#</a></span> J. Prevost</div>  <div class="date">Dec 9, 2012</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/2b14ece5773f901b09597493fabfcfcd?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>I&#8217;d just like to note that this &#8220;optimization wall&#8221; thing has frequently hit me from the opposite side of the equation.  I often like to use CTEs to make my query clearer and more organized&#8211;but because of this effect, it can result in an unworkable query plan.  (As in: going from less than a second to potentially multiple hours.  Not just getting a little less efficient.)</p>
<p>That kind of situation, where the structure of the query must be changed in order to influence the query plan, is exactly what I never want in my DBMS.  So sign me up for &#8220;hints would be a very good thing to have, particularly if they don&#8217;t have to be in-line in the body of the query&#8221;, and a desire that the query planner also do a better job of making a larger variety of similar queries behave the same way.</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2576" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="7001128765" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="238"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">335 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">314 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">264 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">207 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">156 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">150 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">133 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">133 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">131 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">103 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochd</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

