http://www.depesz.com/2014/05/12/joining-btree-and-gingist-indexes/
HTTP/1.1 200 OK
Server: nginx
Date: Tue, 22 Jul 2014 11:21:20 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2865>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Joining BTree and GIN/GiST indexes</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Joining BTree and GIN/GiST indexes Comments Feed" href="http://www.depesz.com/2014/05/12/joining-btree-and-gingist-indexes/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2014/05/12/joining-btree-and-gingist-indexes/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2865' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2865">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2014/05/12/joining-btree-and-gingist-indexes/" rel="bookmark" title="Permanent Link to Joining BTree and GIN/GiST indexes">Joining BTree and GIN/GiST indexes</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>May 12th, 2014 by depesz | Tags: <a href="http://www.depesz.com/tag/btree/" rel="tag">btree</a>, <a href="http://www.depesz.com/tag/btree_gin/" rel="tag">btree_gin</a>, <a href="http://www.depesz.com/tag/btree_gist/" rel="tag">btree_gist</a>, <a href="http://www.depesz.com/tag/fti/" rel="tag">fti</a>, <a href="http://www.depesz.com/tag/fts/" rel="tag">fts</a>, <a href="http://www.depesz.com/tag/gin/" rel="tag">gin</a>, <a href="http://www.depesz.com/tag/gist/" rel="tag">gist</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/tsearch/" rel="tag">tsearch</a> |  <a href="http://www.depesz.com/2014/05/12/joining-btree-and-gingist-indexes/#respond" title="Comment on Joining BTree and GIN/GiST indexes">No comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>Today, I'd like to show you how you can use the same index for two different types of conditions. One that is using normal BTree indexing ( equal, less than, greater than ), and one that is using GIN/GiST index, for full text searching.</p>
<p><span id="more-2865"></span></p>
<p>Before I will go any further &#8211; I will be showing explain analyze plans, but please don't compare times &#8211; the dataset is small (it fits entirely in the memory), and the conditions are picked to select small part of the table, so the timing will be not really impressive.</p>
<p>The point of this post is to show you (in case you didn't know) that you can do certain things, so you can test it in your environment and see how it performs with your data, on your hardware.</p>
<p>With the disclaimer done, let's go. First, we need some test data.</p>
<p>I created simple table:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">                            <span style="color: #993333; font-weight: bold;">Table</span> <span style="color: #ff0000;">&quot;public.test&quot;</span>
    <span style="color: #993333; font-weight: bold;">Column</span>    <span style="color: #66cc66;">|</span>  <span style="color: #993333; font-weight: bold;">Type</span>   <span style="color: #66cc66;">|</span>                     Modifiers                     
<span style="color: #808080; font-style: italic;">--------------+---------+---------------------------------------------------</span>
 id           <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span> <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> <span style="color: #993333; font-weight: bold;">nextval</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'test_id_seq'</span>::regclass<span style="color: #66cc66;">&#41;</span>
 file_path    <span style="color: #66cc66;">|</span> text    <span style="color: #66cc66;">|</span> 
 file_size    <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span> <span style="color: #66cc66;">|</span> 
 file_content <span style="color: #66cc66;">|</span> text    <span style="color: #66cc66;">|</span> 
Indexes:
    <span style="color: #ff0000;">&quot;test_pkey&quot;</span> <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span><span style="color: #66cc66;">,</span> btree <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>To this table, I loaded some data about man/readme/perldoc files from my system.</p>
<p>Content looks like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> id <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">10762</span>;
<span style="color: #66cc66;">-</span><span style="color: #66cc66;">&#91;</span> RECORD <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#93;</span><span style="color: #66cc66;">+</span><span style="color: #808080; font-style: italic;">-------------------------------------------------------</span>
 id           <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">10762</span>
 file_path    <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">/</span>usr<span style="color: #66cc66;">/</span>share<span style="color: #66cc66;">/</span>doc<span style="color: #66cc66;">/</span>texlive<span style="color: #66cc66;">-</span>doc<span style="color: #66cc66;">/</span>latex<span style="color: #66cc66;">/</span>pgf<span style="color: #66cc66;">-</span>umlsd<span style="color: #66cc66;">/</span>README
 file_size    <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">100</span>
 file_content <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">Some</span> LaTeX macros <span style="color: #993333; font-weight: bold;">for</span> UML <span style="color: #993333; font-weight: bold;">Sequence</span> Diagrams<span style="color: #66cc66;">.</span>          <span style="color: #66cc66;">+</span>
              <span style="color: #66cc66;">|</span> Home page <span style="color: #993333; font-weight: bold;">of</span> project: http:<span style="color: #66cc66;">//</span>pgf<span style="color: #66cc66;">-</span>umlsd<span style="color: #66cc66;">.</span>googlecode<span style="color: #66cc66;">.</span>com<span style="color: #66cc66;">/+</span>
              <span style="color: #66cc66;">|</span></pre></td></tr></table></div>

<p>Of course this is rather short readme. There are others. Some quick stats:</p>
<ul>
<li>Total number of records: 11974</li>
<li>Table size: 58MB</li>
<li>Minimal size of content: 1 character</li>
<li>Average size of content: 10,096 characters</li>
<li>Maximal size of content: 837,009 characters</li>
<li>Total size of content: 120,899,970</li>
</ul>
<p>The data size is not really impressive, but that's not the point.</p>
<p>First, let's see some sample queries:</p>
<pre>
-- number of documents containing the word "jpeg":
$ explain analyze select count(*) from test where file_content ~* 'jpeg';
                                                QUERY PLAN                                                 
-----------------------------------------------------------------------------------------------------------
 Aggregate  (cost=1423.68..1423.69 rows=1 width=0) (actual time=975.556..975.556 rows=1 loops=1)
   ->  Seq Scan on test  (cost=0.00..1423.67 rows=1 width=0) (actual time=3.504..975.486 rows=168 loops=1)
         Filter: (file_content ~* 'jpeg'::text)
         Rows Removed by Filter: 11806
 Planning time: 0.915 ms
 Execution time: 975.578 ms
(6 rows)
</pre>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">-- number of documents smaller than 700 characters:</span>
$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span>;
                                                 QUERY PLAN                                                  
<span style="color: #808080; font-style: italic;">-------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1426.39</span><span style="color: #66cc66;">..</span>1426<span style="color: #66cc66;">.</span>40 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1.938</span><span style="color: #66cc66;">..</span>1<span style="color: #66cc66;">.</span>938 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>1423<span style="color: #66cc66;">.</span>67 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1086</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.004</span><span style="color: #66cc66;">..</span>1<span style="color: #66cc66;">.</span>851 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1089</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">10885</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.041</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">1.956</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">6</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>And finally, the most interesting query:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">-- number of documents smaller than 700 characters, and containing work &quot;jpeg&quot;</span>
$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span> <span style="color: #993333; font-weight: bold;">and</span> file_content ~<span style="color: #66cc66;">*</span> <span style="color: #ff0000;">'jpeg'</span>;
                                              QUERY PLAN                                               
<span style="color: #808080; font-style: italic;">-------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1453.61</span><span style="color: #66cc66;">..</span>1453<span style="color: #66cc66;">.</span>62 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5.160</span><span style="color: #66cc66;">..</span>5<span style="color: #66cc66;">.</span>160 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>1453<span style="color: #66cc66;">.</span>61 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1.569</span><span style="color: #66cc66;">..</span>5<span style="color: #66cc66;">.</span>158 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>file_content ~<span style="color: #66cc66;">*</span> <span style="color: #ff0000;">'jpeg'</span>::text<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">11972</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.907</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">5.177</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">6</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>OK. All times were taken by running the query 3 times and picking best one.</p>
<p>Anyway. Let's assume we want the size limiting queries to run fast. Obviously, we should create index on file_size:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i1 <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #66cc66;">&#40;</span>file_size<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
&nbsp;
$ vacuum analyze test;
VACUUM</pre></td></tr></table></div>

<p>Now, the queries that use file_size, should be faster:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span>;
                                                        QUERY PLAN                                                         
<span style="color: #808080; font-style: italic;">---------------------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">38.00</span><span style="color: #66cc66;">..</span>38<span style="color: #66cc66;">.</span>01 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.626</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>626 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Index</span> <span style="color: #993333; font-weight: bold;">Only</span> Scan <span style="color: #993333; font-weight: bold;">using</span> i1 <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.29</span><span style="color: #66cc66;">..</span>35<span style="color: #66cc66;">.</span>29 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1086</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.039</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>415 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1089</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span>
         Heap Fetches: <span style="color: #cc66cc;">0</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.068</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.657</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">6</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span> <span style="color: #993333; font-weight: bold;">and</span> file_content ~<span style="color: #66cc66;">*</span> <span style="color: #ff0000;">'jpeg'</span>;
                                                       QUERY PLAN                                                       
<span style="color: #808080; font-style: italic;">------------------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1320.78</span><span style="color: #66cc66;">..</span>1320<span style="color: #66cc66;">.</span>79 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4.422</span><span style="color: #66cc66;">..</span>4<span style="color: #66cc66;">.</span>422 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">24.43</span><span style="color: #66cc66;">..</span>1320<span style="color: #66cc66;">.</span>77 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1.163</span><span style="color: #66cc66;">..</span>4<span style="color: #66cc66;">.</span>419 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         Recheck Cond: <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span>file_content ~<span style="color: #66cc66;">*</span> <span style="color: #ff0000;">'jpeg'</span>::text<span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">1087</span>
         Heap Blocks: exact<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">596</span>
         <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>24<span style="color: #66cc66;">.</span>43 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1086</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.127</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>127 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1089</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
               <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">1.012</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">4.446</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Again, please disregard the fact that we have very small time differences &#8211; it's very small dataset, and I just want to show &#8220;a thing", and not necessarily how great it is &#8211; as this will directly depend on your data size.</p>
<p>What about the &#8220;jpeg" queries &#8211; well, we can use tsearch indexes.</p>
<p>For now, let's assume I'll just use GIN indexing:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i2 <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #993333; font-weight: bold;">using</span> gin <span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #66cc66;">...</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
&nbsp;
$ vacuum analyze test;
<span style="color: #66cc66;">...</span>
VACUUM</pre></td></tr></table></div>

<p>Now, the query that is searching for jpeg (after slight modification) will use the index:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">'jpeg'</span>;
                                                     QUERY PLAN                                                      
<span style="color: #808080; font-style: italic;">---------------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">215.43</span><span style="color: #66cc66;">..</span>215<span style="color: #66cc66;">.</span>44 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.178</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>178 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">16.47</span><span style="color: #66cc66;">..</span>215<span style="color: #66cc66;">.</span>28 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">60</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.063</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>151 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">119</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         Recheck Cond: <span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span>::regconfig<span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">''</span><span style="color: #ff0000;">'jpeg'</span><span style="color: #ff0000;">''</span>::tsquery<span style="color: #66cc66;">&#41;</span>
         Heap Blocks: exact<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">104</span>
         <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i2  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>16<span style="color: #66cc66;">.</span>45 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">60</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.043</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>043 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">119</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
               <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span>::regconfig<span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">''</span><span style="color: #ff0000;">'jpeg'</span><span style="color: #ff0000;">''</span>::tsquery<span style="color: #66cc66;">&#41;</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.185</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.210</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">8</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>But what will happen if I'll try to use both of the conditions?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">'jpeg'</span> <span style="color: #993333; font-weight: bold;">and</span> file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span>;
                                                          QUERY PLAN                                                          
<span style="color: #808080; font-style: italic;">------------------------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">60.29</span><span style="color: #66cc66;">..</span>60<span style="color: #66cc66;">.</span>30 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.330</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>330 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">41.13</span><span style="color: #66cc66;">..</span>60<span style="color: #66cc66;">.</span>28 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.327</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>327 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         Recheck Cond: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span>::regconfig<span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">''</span><span style="color: #ff0000;">'jpeg'</span><span style="color: #ff0000;">''</span>::tsquery<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
         Heap Blocks: exact<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span>
         <span style="color: #66cc66;">-&gt;</span>  BitmapAnd  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">41.13</span><span style="color: #66cc66;">..</span>41<span style="color: #66cc66;">.</span>13 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.323</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>323 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
               <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i2  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>16<span style="color: #66cc66;">.</span>45 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">60</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.044</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>044 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">119</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
                     <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span>::regconfig<span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">''</span><span style="color: #ff0000;">'jpeg'</span><span style="color: #ff0000;">''</span>::tsquery<span style="color: #66cc66;">&#41;</span>
               <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i1  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>24<span style="color: #66cc66;">.</span>43 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1086</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.251</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>251 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1089</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
                     <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.197</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.365</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">11</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Both indexes are used, but there is some additional logic that's needed to &#8220;join" results from them.</p>
<p>It would be better to have single, multi-column, index that would satisfy this query. Unfortunately you can't:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i3 <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #993333; font-weight: bold;">using</span> gin <span style="color: #66cc66;">&#40;</span>file_size<span style="color: #66cc66;">,</span> to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>;
ERROR:  <span style="color: #993333; font-weight: bold;">data</span> <span style="color: #993333; font-weight: bold;">type</span> <span style="color: #993333; font-weight: bold;">integer</span> has no <span style="color: #993333; font-weight: bold;">default</span> operator class <span style="color: #993333; font-weight: bold;">for</span> access method <span style="color: #ff0000;">&quot;gin&quot;</span>
HINT:  You must specify an operator class <span style="color: #993333; font-weight: bold;">for</span> the <span style="color: #993333; font-weight: bold;">index</span> <span style="color: #993333; font-weight: bold;">or</span> define a <span style="color: #993333; font-weight: bold;">default</span> operator class <span style="color: #993333; font-weight: bold;">for</span> the <span style="color: #993333; font-weight: bold;">data</span> <span style="color: #993333; font-weight: bold;">type</span><span style="color: #66cc66;">.</span></pre></td></tr></table></div>

<p>or:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i3 <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #993333; font-weight: bold;">using</span> gin <span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> file_size<span style="color: #66cc66;">&#41;</span>;
ERROR:  <span style="color: #993333; font-weight: bold;">data</span> <span style="color: #993333; font-weight: bold;">type</span> <span style="color: #993333; font-weight: bold;">integer</span> has no <span style="color: #993333; font-weight: bold;">default</span> operator class <span style="color: #993333; font-weight: bold;">for</span> access method <span style="color: #ff0000;">&quot;gin&quot;</span>
HINT:  You must specify an operator class <span style="color: #993333; font-weight: bold;">for</span> the <span style="color: #993333; font-weight: bold;">index</span> <span style="color: #993333; font-weight: bold;">or</span> define a <span style="color: #993333; font-weight: bold;">default</span> operator class <span style="color: #993333; font-weight: bold;">for</span> the <span style="color: #993333; font-weight: bold;">data</span> <span style="color: #993333; font-weight: bold;">type</span><span style="color: #66cc66;">.</span></pre></td></tr></table></div>

<p>Luckily, there are extensions. And one of them is gin_btree (there is also gist_btree if your &#8220;base" index has to be gist).</p>
<p>What it is &#8211; it adds &#8220;btree" type of operators support to gin index. So we can:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> extension btree_gin;
<span style="color: #993333; font-weight: bold;">CREATE</span> EXTENSION
<span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i3 <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #993333; font-weight: bold;">using</span> gin <span style="color: #66cc66;">&#40;</span>file_size<span style="color: #66cc66;">,</span> to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #66cc66;">...</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
analyze test;
<span style="color: #66cc66;">...</span>
ANALYZE</pre></td></tr></table></div>

<p>And now:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span><span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">'jpeg'</span> <span style="color: #993333; font-weight: bold;">and</span> file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span>;
                                                         QUERY PLAN                                                         
<span style="color: #808080; font-style: italic;">----------------------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">59.22</span><span style="color: #66cc66;">..</span>59<span style="color: #66cc66;">.</span>23 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.510</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>511 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Bitmap Heap Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">40.06</span><span style="color: #66cc66;">..</span>59<span style="color: #66cc66;">.</span>21 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.508</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>508 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         Recheck Cond: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span>::regconfig<span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">''</span><span style="color: #ff0000;">'jpeg'</span><span style="color: #ff0000;">''</span>::tsquery<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
         Heap Blocks: exact<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span>
         <span style="color: #66cc66;">-&gt;</span>  Bitmap <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">on</span> i3  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>40<span style="color: #66cc66;">.</span>06 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.503</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>503 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
               <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>to_tsvector<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'english'</span>::regconfig<span style="color: #66cc66;">,</span> file_content<span style="color: #66cc66;">&#41;</span> @@ <span style="color: #ff0000;">''</span><span style="color: #ff0000;">'jpeg'</span><span style="color: #ff0000;">''</span>::tsquery<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>file_size <span style="color: #66cc66;">&lt;</span> <span style="color: #cc66cc;">700</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
 Planning <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.241</span> ms
 Execution <span style="color: #993333; font-weight: bold;">time</span>: <span style="color: #cc66cc;">0.549</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">8</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>As you can see the timing is not so good now (worse than 0.365ms earlier, with two separate indexes), but that could be due to number of reasons.</p>
<p>The important part is: with btree_gin gin indexes can be used to do standard comparisons, so you can make single index that handles both conditions on integers and full text searches. Same goes with GiST, but then the extension is named btree_gist.</p>
<p>I just thought that you might have a use-case for it, and perhaps you never knew about this feature. Have fun <img src="http://www.depesz.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> </p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">



	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2865" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="9e2a9926f6" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="214"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">2 comments</span> | <span class="wpp-views">643 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">4 comments</span> | <span class="wpp-views">617 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">279 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">214 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">151 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">146 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">132 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">131 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">119 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">104 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochd</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

