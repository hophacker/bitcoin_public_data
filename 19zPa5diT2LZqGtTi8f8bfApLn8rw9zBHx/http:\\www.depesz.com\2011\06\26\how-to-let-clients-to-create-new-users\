http://www.depesz.com/2011/06/26/how-to-let-clients-to-create-new-users/
HTTP/1.1 200 OK
Server: nginx
Date: Tue, 22 Jul 2014 23:36:28 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2202>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; How to let clients to create new users?</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; How to let clients to create new users? Comments Feed" href="http://www.depesz.com/2011/06/26/how-to-let-clients-to-create-new-users/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2011/06/26/how-to-let-clients-to-create-new-users/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2202' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2202">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2011/06/26/how-to-let-clients-to-create-new-users/" rel="bookmark" title="Permanent Link to How to let clients to create new users?">How to let clients to create new users?</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>June 26th, 2011 by depesz | Tags: <a href="http://www.depesz.com/tag/administration/" rel="tag">administration</a>, <a href="http://www.depesz.com/tag/clients/" rel="tag">clients</a>, <a href="http://www.depesz.com/tag/hosting/" rel="tag">hosting</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/shared/" rel="tag">shared</a>, <a href="http://www.depesz.com/tag/users/" rel="tag">users</a> |  <a href="http://www.depesz.com/2011/06/26/how-to-let-clients-to-create-new-users/#comments" title="Comment on How to let clients to create new users?">3 comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>Some (quite long) time ago, someone, somewhere (my memory is pretty fragile) asked a question. I don't have it exact, but the gist was: is it possible to give some users rights to create new users, without making them superusers, and forcing new users to have access only to one particular database.</p>
<p>After some discussion it was clear that the scenario was shared hosting with PostgreSQL, so the situation could look like this:</p>
<p>you are administrator of shared hosting service. One of services is PostgreSQL. You have client, named &#8220;depesz", and you want him to be able to create new users, but these users shouldn't be able to connect to any other database than depesz's db.</p>
<p>Is it doable?</p>
<p><span id="more-2202"></span></p>
<p>First problem is that if we'd give our client privilege to create user &#8211; he will get &#8220;superuser" privileges:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">user</span> client;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">ROLE</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">alter</span> <span style="color: #993333; font-weight: bold;">user</span> client <span style="color: #993333; font-weight: bold;">with</span> createuser;
<span style="color: #993333; font-weight: bold;">ALTER</span> <span style="color: #993333; font-weight: bold;">ROLE</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> pg_authid <span style="color: #993333; font-weight: bold;">where</span> rolname <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'client'</span>;
<span style="color: #66cc66;">-</span><span style="color: #66cc66;">&#91;</span> RECORD <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#93;</span><span style="color: #808080; font-style: italic;">--+-------</span>
rolname        <span style="color: #66cc66;">|</span> client
rolsuper       <span style="color: #66cc66;">|</span> t
rolinherit     <span style="color: #66cc66;">|</span> t
rolcreaterole  <span style="color: #66cc66;">|</span> f
rolcreatedb    <span style="color: #66cc66;">|</span> f
rolcatupdate   <span style="color: #66cc66;">|</span> t
rolcanlogin    <span style="color: #66cc66;">|</span> t
rolreplication <span style="color: #66cc66;">|</span> f
rolconnlimit   <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">-</span><span style="color: #cc66cc;">1</span>
rolpassword    <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
rolvaliduntil  <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span></pre></td></tr></table></div>

<p>So, it looks like a no go. But is it really? Perhaps we could make a function that would make it work? Client would call the function, and the function would do the job. Usually functions run with the privileges of user that is executing them, but we have the cool feature of &#8220;SECURITY DEFINER" functions.</p>
<p>With this in mind, let's write down some requirements.</p>
<ul>
<li>every user has to be created with password</li>
<li>only owners of a database can create new users</li>
<li>created user will have only access to the database it was created in/for</li>
</ul>
<p>Let's start from the end. Making sure user has no rights to connect to all (except some) databases can be done in 2 ways:</p>
<ul>
<li>revoke privileges to connect to every database from given user</li>
<li>revoke privileges to connect to every database from &#8220;public"</li>
</ul>
<p>I prefer the 2nd solution, because it's easier &#8211; with 3 databases, and 10 users, we would have to issue 27 revokes in #1, but only 3 in #2, plus 3 grants.</p>
<p>It would be great if we could simply wrap it all in stored procedure, but unfortunately PostgreSQL (as of now) doesn't let you run <b>create database</b> in function or transaction.</p>
<p>Due to this limitation, we have to either use dblink (which we don't want in such a simple tutorial), or just write all the commands ourselver.</p>
<p>Whenever we will have new client, we will have to run 3 commands:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">USER</span> whatever <span style="color: #993333; font-weight: bold;">WITH</span> PASSWORD <span style="color: #ff0000;">'xxx'</span>;
&nbsp;
$ <span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">DATABASE</span> whatever <span style="color: #993333; font-weight: bold;">WITH</span> OWNER whatever;
&nbsp;
$ <span style="color: #993333; font-weight: bold;">REVOKE</span> <span style="color: #993333; font-weight: bold;">ALL</span> <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #993333; font-weight: bold;">DATABASE</span> whatever <span style="color: #993333; font-weight: bold;">FROM</span> public;</pre></td></tr></table></div>

<p>Thanks to this we will have specialized user being owner of the database, and no other user (except superusers of course) will be able to connect to this database.</p>
<p>It we have any other databases, we should revoke public login too, with simple query:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ DO <span style="color: #993333; font-weight: bold;">LANGUAGE</span> plpgsql $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    temprec record;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #993333; font-weight: bold;">FOR</span> temprec <span style="color: #993333; font-weight: bold;">IN</span> <span style="color: #993333; font-weight: bold;">SELECT</span> datname <span style="color: #993333; font-weight: bold;">FROM</span> pg_database <span style="color: #993333; font-weight: bold;">WHERE</span> datallowconn LOOP
        <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'REVOKE ALL ON DATABASE '</span> <span style="color: #66cc66;">||</span> quote_ident<span style="color: #66cc66;">&#40;</span> temprec<span style="color: #66cc66;">.</span>datname <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' FROM public'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> LOOP;
<span style="color: #993333; font-weight: bold;">END</span>;
$$;</pre></td></tr></table></div>

<p>Afterwards we have all databases secured to the point where only owner of a database can connect to it (and superusers).</p>
<p>Now. What about additional users? Since user creation can be done in function, we can write something like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> create_new_db_user <span style="color: #66cc66;">&#40;</span>p_login TEXT<span style="color: #66cc66;">,</span> p_password TEXT <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> void <span style="color: #993333; font-weight: bold;">AS</span> $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    v_login TEXT :<span style="color: #66cc66;">=</span> quote_ident<span style="color: #66cc66;">&#40;</span> p_login <span style="color: #66cc66;">&#41;</span>;
    v_owner TEXT;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #808080; font-style: italic;">-- It should work for db owner only</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> u<span style="color: #66cc66;">.</span>usename <span style="color: #993333; font-weight: bold;">INTO</span> v_owner <span style="color: #993333; font-weight: bold;">FROM</span> pg_database d <span style="color: #993333; font-weight: bold;">JOIN</span> pg_user u <span style="color: #993333; font-weight: bold;">on</span> d<span style="color: #66cc66;">.</span>datdba <span style="color: #66cc66;">=</span> u<span style="color: #66cc66;">.</span>usesysid <span style="color: #993333; font-weight: bold;">WHERE</span> d<span style="color: #66cc66;">.</span>datname <span style="color: #66cc66;">=</span> current_database<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">IF</span> v_owner <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> session_user <span style="color: #993333; font-weight: bold;">THEN</span>
        RAISE EXCEPTION <span style="color: #ff0000;">'Only database owner (%) can run this function.'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'CREATE USER '</span> <span style="color: #66cc66;">||</span> v_login <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' WITH PASSWORD '</span> <span style="color: #66cc66;">||</span> quote_literal<span style="color: #66cc66;">&#40;</span> p_password <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'GRANT CONNECT, TEMPORARY ON DATABASE '</span> <span style="color: #66cc66;">||</span> quote_ident<span style="color: #66cc66;">&#40;</span> current_database<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' TO '</span> <span style="color: #66cc66;">||</span> v_login;
    <span style="color: #993333; font-weight: bold;">RETURN</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql SECURITY DEFINER;</pre></td></tr></table></div>

<p>This function, when created in client database, gives the user ability to create new users, which can connect only to their database:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #66cc66;">&#40;</span>whatever@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:03:02 <span style="color: #66cc66;">&#91;</span>whatever<span style="color: #66cc66;">&#93;</span>
$ \du
                                    List <span style="color: #993333; font-weight: bold;">of</span> roles
        <span style="color: #993333; font-weight: bold;">Role</span> name        <span style="color: #66cc66;">|</span>                   Attributes                   <span style="color: #66cc66;">|</span> Member <span style="color: #993333; font-weight: bold;">of</span>
<span style="color: #808080; font-style: italic;">-------------------------+------------------------------------------------+-----------</span>
 depesz                  <span style="color: #66cc66;">|</span> Superuser<span style="color: #66cc66;">,</span> Replication                         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
 pgdba                   <span style="color: #66cc66;">|</span> Superuser<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">Create</span> <span style="color: #993333; font-weight: bold;">role</span><span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">Create</span> DB<span style="color: #66cc66;">,</span> Replication <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
 postgres                <span style="color: #66cc66;">|</span> Superuser<span style="color: #66cc66;">,</span> Replication                         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
 whatever                <span style="color: #66cc66;">|</span>                                                <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>whatever@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:03:<span style="color: #cc66cc;">10</span> <span style="color: #66cc66;">&#91;</span>whatever<span style="color: #66cc66;">&#93;</span>
$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">current_user</span><span style="color: #66cc66;">,</span> session_user;
 <span style="color: #993333; font-weight: bold;">current_user</span> <span style="color: #66cc66;">|</span> session_user
<span style="color: #808080; font-style: italic;">--------------+--------------</span>
 whatever     <span style="color: #66cc66;">|</span> whatever
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>whatever@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:03:<span style="color: #cc66cc;">34</span> <span style="color: #66cc66;">&#91;</span>whatever<span style="color: #66cc66;">&#93;</span>
$ <span style="color: #993333; font-weight: bold;">select</span> create_new_db_user<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">'xxx'</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'pass'</span> <span style="color: #66cc66;">&#41;</span>;
 create_new_db_user
<span style="color: #808080; font-style: italic;">--------------------</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
<span style="color: #cc66cc;">17</span>:03:<span style="color: #cc66cc;">48</span> depesz@h3po4 ~
<span style="color: #66cc66;">=</span>$ psql <span style="color: #66cc66;">-</span>U xxx <span style="color: #66cc66;">-</span>d whatever
psql <span style="color: #66cc66;">&#40;</span>9<span style="color: #66cc66;">.</span>2devel<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">Type</span> <span style="color: #ff0000;">&quot;help&quot;</span> <span style="color: #993333; font-weight: bold;">for</span> help<span style="color: #66cc66;">.</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>xxx@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:03:<span style="color: #cc66cc;">56</span> <span style="color: #66cc66;">&#91;</span>whatever<span style="color: #66cc66;">&#93;</span> 
$</pre></td></tr></table></div>

<p>As you can see user &#8220;xxx" can now connect to database whatever, while it cannot connect to others:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #66cc66;">=</span>$ psql <span style="color: #66cc66;">-</span>U xxx <span style="color: #66cc66;">-</span>d postgres
psql: FATAL:  permission denied <span style="color: #993333; font-weight: bold;">for</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;postgres&quot;</span>
DETAIL:  <span style="color: #993333; font-weight: bold;">User</span> does <span style="color: #993333; font-weight: bold;">not</span> have <span style="color: #993333; font-weight: bold;">CONNECT</span> privilege<span style="color: #66cc66;">.</span></pre></td></tr></table></div>

<p>To make it work sensibly, we'll need to create this function in all databases. For new databases (ones that will be created in future) it's enough to create it in template1, but in others &#8211; we have to do it &#8220;manually".</p>
<p>Thankfully psql can help quite a bit.</p>
<p>Let's assume the file with function definition is in /tmp/function.sql file.</p>
<p>So, now, I'll login to pg as super user, and will:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">21</span> <span style="color: #66cc66;">&#91;</span>postgres<span style="color: #66cc66;">&#93;</span>
$ \pset format unaligned
Output format <span style="color: #993333; font-weight: bold;">is</span> unaligned<span style="color: #66cc66;">.</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">24</span> <span style="color: #66cc66;">&#91;</span>postgres<span style="color: #66cc66;">&#93;</span>
$ \pset tuples_only
Showing <span style="color: #993333; font-weight: bold;">only</span> tuples<span style="color: #66cc66;">.</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">32</span> <span style="color: #66cc66;">&#91;</span>postgres<span style="color: #66cc66;">&#93;</span>
$ \o <span style="color: #66cc66;">/</span>tmp<span style="color: #66cc66;">/</span>loader<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">sql</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">38</span> <span style="color: #66cc66;">&#91;</span>postgres<span style="color: #66cc66;">&#93;</span>
$ <span style="color: #993333; font-weight: bold;">select</span> E<span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\\</span>c '</span> <span style="color: #66cc66;">||</span> quote_ident<span style="color: #66cc66;">&#40;</span>datname<span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">||</span> E<span style="color: #ff0000;">'<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\\</span>i /tmp/function.sql'</span> <span style="color: #993333; font-weight: bold;">from</span> pg_database <span style="color: #993333; font-weight: bold;">where</span> datallowconn;
&nbsp;
<span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">40</span> <span style="color: #66cc66;">&#91;</span>postgres<span style="color: #66cc66;">&#93;</span>
$ \o
&nbsp;
<span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">41</span> <span style="color: #66cc66;">&#91;</span>postgres<span style="color: #66cc66;">&#93;</span>
$ \i <span style="color: #66cc66;">/</span>tmp<span style="color: #66cc66;">/</span>loader<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">sql</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;whatever&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;qwerty&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;rt&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;template1&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;postgres&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;depesz&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;depesz_explain&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
You are now connected <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #993333; font-weight: bold;">database</span> <span style="color: #ff0000;">&quot;pgdba&quot;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">user</span> <span style="color: #ff0000;">&quot;postgres&quot;</span><span style="color: #66cc66;">.</span>
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span>
&nbsp;
<span style="color: #66cc66;">&#40;</span>postgres@<span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">local</span><span style="color: #66cc66;">&#93;</span>:<span style="color: #cc66cc;">5910</span><span style="color: #66cc66;">&#41;</span> <span style="color: #cc66cc;">17</span>:09:<span style="color: #cc66cc;">46</span> <span style="color: #66cc66;">&#91;</span>pgdba<span style="color: #66cc66;">&#93;</span>
$</pre></td></tr></table></div>

<p>/tmp/loader.sql file contains (in my database):</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">=$ cat /tmp/loader.sql
\c whatever
\i /tmp/function.sql
\c qwerty
\i /tmp/function.sql
\c rt
\i /tmp/function.sql
\c template1
\i /tmp/function.sql
\c postgres
\i /tmp/function.sql
\c depesz
\i /tmp/function.sql
\c depesz_explain
\i /tmp/function.sql
\c pgdba
\i /tmp/function.sql</pre></td></tr></table></div>

<p>Of course after it got executed both /tmp/loader.sql and /tmp/function.sql can be removed.</p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">3 comments <a href='http://www.depesz.com/2011/06/26/how-to-let-clients-to-create-new-users/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-33835" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-33835" title="">#</a></span> <a href='http://www.xenoterracide.com' rel='external nofollow' class='url'>Caleb Cushing ( xenoterracide )</a></div>  <div class="date">Jun 26, 2011</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/e990c7cdac81e570939c4d5b17303b42?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>ugh&#8230; the fact that you would need to do this kills me&#8230; dear postgres please add role&#8217;s for create database create user that can be assigned to regular users like other roles.</p>
	</li>
		
		
			
<li class="odd" id="comment-33839" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-33839" title="">#</a></span> Isaac Morland</div>  <div class="date">Jun 26, 2011</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/a89a1ded98b870d5a37becf0097a9626?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>I think you need CREATEROLE rather than CREATEUSER.  See: <a href="http://www.postgresql.org/docs/9.0/interactive/sql-createrole.html" rel="nofollow">http://www.postgresql.org/docs/9.0/interactive/sql-createrole.html</a></p>
<p>Of course, there still may be a place for a security definer function to arrange the proper permissions for created roles.</p>
	</li>
		
		
			
<li class="odd" id="comment-33843" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-33843" title="">#</a></span> <a href='http://www.chotchki.us' rel='external nofollow' class='url'>Christopher Hotchkiss (Chotchki)</a></div>  <div class="date">Jun 26, 2011</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/3147775e8e6149886450dc0869e78483?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Caleb, the issue with Postgres is that by default all users/roles are shared between all databases. Also if you grant the right to create roles, the user can create any role they want. So that is why you end up wanting to lock down how people create users to meet the security restrictions you want.</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2202" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="66a8f26a2d" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="111"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">4 comments</span> | <span class="wpp-views">586 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">362 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">246 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">191 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">147 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">130 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">117 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">115 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">112 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/11/14/how-i-learned-to-stop-worrying-and-love-the-triggers/" title="How I Learned to Stop Worrying and Love the Triggers" class="wpp-post-title" target="_self">How I Learned to Stop Worrying and Love the Triggers</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">97 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samoch√≥d</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

