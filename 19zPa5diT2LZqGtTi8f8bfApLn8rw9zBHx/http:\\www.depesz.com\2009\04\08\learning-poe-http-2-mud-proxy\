http://www.depesz.com/2009/04/08/learning-poe-http-2-mud-proxy/
HTTP/1.1 200 OK
Server: nginx
Date: Wed, 23 Jul 2014 16:15:13 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=1404>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Learning POE: HTTP-2-MUD proxy</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Learning POE: HTTP-2-MUD proxy Comments Feed" href="http://www.depesz.com/2009/04/08/learning-poe-http-2-mud-proxy/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2009/04/08/learning-poe-http-2-mud-proxy/' />
<link rel='shortlink' href='http://www.depesz.com/?p=1404' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-1404">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2009/04/08/learning-poe-http-2-mud-proxy/" rel="bookmark" title="Permanent Link to Learning POE: HTTP-2-MUD proxy">Learning POE: HTTP-2-MUD proxy</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>April 8th, 2009 by depesz | Tags: <a href="http://www.depesz.com/tag/mud/" rel="tag">mud</a>, <a href="http://www.depesz.com/tag/mud-proxy/" rel="tag">mud-proxy</a>, <a href="http://www.depesz.com/tag/perl/" rel="tag">perl</a>, <a href="http://www.depesz.com/tag/poe/" rel="tag">poe</a>, <a href="http://www.depesz.com/tag/proxy/" rel="tag">proxy</a> |  <a href="http://www.depesz.com/2009/04/08/learning-poe-http-2-mud-proxy/#comments" title="Comment on Learning POE: HTTP-2-MUD proxy">3 comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>Some years ago I learned of existence of (supposedly cool) <a href="http://poe.perl.org">POE framework</a> for Perl. I tried to use it for some projects, but the learning curve proved to be fatal for my interest.</p>
<p>All the time I felt that POE is great, it's just that I'm too stupid to be able to actively use it.</p>
<p>Time passed by. Something like half a year ago, <a href="http://gurthg.killer.mud.pl/">friend</a> asked me if it would be possible for me to write a cool program &#8211; HTTP proxy for <a href="http://www.killer.mud.pl/">their</a> <acronym title="Multi-User Dungeon">MUD</acronym>.</p>
<p><span id="more-1404"></span></p>
<p>In case you're not familiar &#8211; <a href="http://en.wikipedia.org/wiki/MUD">MUD</a> is a quite old type of game, that involves many users playing simultaneously on server (think: <a href="http://en.wikipedia.org/wiki/MMORPG">MMORPG</a>) but without graphics.</p>
<p>All information is provided as text &#8211; location descriptions, actions, everything.</p>
<p>The thing is that MUD works as TCP server, accessible usually with <i>telnet</i> program, or some specialized programs which add capabilities like scripting. But the core game is played over open TCP connection between client and server. If the connection is lost, you can't play.</p>
<p>Now, this is in direct contrary to HTTP, which is stateless protocol &#8211; send request, get response, close connection. Of course there are things like Keep-Alive connections, or push channels, but they all seem to be &#8220;not cool".</p>
<p>So, we envisioned a proxy, that would act as http server, but pass information to and from MUD server, keeping connection between MUD and proxy open all the time.</p>
<p>Typical flow of data in it would be:</p>
<ol>
<li>proxy gets initial request from client (http)</li>
<li>proxy opens connection to server, and returns session id to client</li>
<li>whenever server &#8220;says" something, proxy buffers the data for client</li>
<li>whenever client sends request &#8211; proxy returns all data from buffer to him</li>
<li>if client provides &#8220;command" to be sent to mud, it is passed to mud using mud connection associated with given http-session-id.</li>
<li>if server will close connection &#8211; proxy should keep this information for client, together with last (not yet received) messages from server, to be passed to client</li>
</ol>
<p>If you ever heard about POE or anything like it (for example <a href="http://twistedmatrix.com">Twisted</a> in Pythonland), you should <i>see</i> that description of the proxy matches perfectly what POE can (or at least should) do.</p>
<p>Given this, and my previous attempts at using POE, I decided to write it in POE &#8211; killing 2 birds with 1 stone &#8211; writing program for friend, and learning something new.</p>
<p>It took me longer than expected, but finally &#8211; it's done. First version is available to be <a href="http://svn.depesz.com/svn/mud-proxy/">downloaded</a> and <a href="http://www.mail-archive.com/poe@perl.org/msg04139.html">scrutinized</a>.</p>
<p>Right now, it's not fully completed &#8211; i.e. there is no configuration file, logs, and so on, but the program itself works, and works quite nicely (at least &#8211; as far as my tests go).</p>
<p>In mud-proxy.pl (which is the proxy itself, test-server.pl is just some test tcp server I wrote to be able to test proxy), important parts are:</p>
<p><code>my $server = POE::Component::Server::HTTPServer-&gt;new(<br />
    'port'     =&gt; 8181,<br />
    'handlers' =&gt; [<br />
        '/mud' =&gt; \&#038;handle_requests,<br />
        '/'    =&gt; new_handler( 'NotFoundHandler' ),<br />
    ],<br />
);</code></p>
<p>Which starts the HTTP part of the proxy on tcp port 8181, and adds handler for /mud url.</p>
<p><code>my $mud = POE::Component::Client::TCP-&gt;new(<br />
    'RemoteAddress' =&gt; '127.0.0.1',<br />
    'RemotePort'    =&gt; '9000',<br />
    'Alias'         =&gt; $client_id,<br />
...</code></p>
<p>Which starts connection to MUD server, assuming it works on 127.0.0.1:9000.</p>
<p>Once running, you can request http://127.0.0.1:8181/mud to get data from server, and pass your input as cmd http parameters.</p>
<p>For example, sending request:</p>
<p>http://127.0.0.1:8181/mud?cmd=ls%20-l</p>
<p>will send &#8220;ls -l" command to mud server.</p>
<p>As far as commands go &#8211; proxy adds &#8220;\r\n" at the end of cmd, but only if it is not already there.</p>
<p>Of course this proxy can be used with any server, not only MUD. As long as the server uses TCP communication over defined port &#8211; it can be proxied to using mud-proxy.</p>
<p>As you will probably notice there are not much of security checks in the code &#8211; this is simply because the program (as it is now) is meant to be used as a backend, and be called from some front layer (php? mod_perl?  django? whatever), and not directly web browser, though it is of course possible to add security measures, extensive logging, and basically anything that you could find useful.</p>
<p>Finally, I would like to express my sincere &#8220;THANK YOU" to all helpful souls on #poe channel on irc.perl.org that helped me whenever I felt lost (approximately every 15 seconds). Without you I wouldn't be able to write it.</p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">3 comments <a href='http://www.depesz.com/2009/04/08/learning-poe-http-2-mud-proxy/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-27689" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-27689" title="">#</a></span> James</div>  <div class="date">Apr 10, 2009</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d641bb93da41dd75b5c863217e3601f2?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Coro/AnyEvent are way superior in terms of usability and performance.  They just lack the numbers of dependent modules POE has, though with Coro::Select you can use many modules that use blocking selects, which you can&#8217;t with POE.</p>
	</li>
		
		
			
<li class="odd" id="comment-29875" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-29875" title="">#</a></span> Anonymous</div>  <div class="date">Jun 8, 2010</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/?d=identicon&amp;s=64' class='avatar avatar-64 photo avatar-default' height='64' width='64' />		<p>I have done similar things with POE. It works quite great, but POE does have problems scaling. When you go over 1000 sessions, garbage-collection of sessions often becomes a longwinded task that makes the entire program lag &#8212; so if you want to use this with many clients, I would recommend running more than one instance, such that each instance takes care of maybe 500 users at most. I did try these kind of things with up to 5000 connections to one POE process, but the process often started to hang for up to two minutes when it had to GC lots of sessions.</p>
	</li>
		
		
			
<li class="odd" id="comment-30016" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-30016" title="">#</a></span> <a href='http://poe.perl.org/' rel='external nofollow' class='url'>Rocco Caputo</a></div>  <div class="date">Jul 6, 2010</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/3d4f61dae367905f646713ee2a0b65c5?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@james</p>
<p>POE performance is often a factor of how it&#8217;s used.  Programs using POE can perform very well when written with performance in mind.   See <a href="http://gyazo.com/ecbcad673a0a47bb08c9b6b8c03b857b.png" rel="nofollow">http://gyazo.com/ecbcad673a0a47bb08c9b6b8c03b857b.png</a> for an example.</p>
<p>@anonymous</p>
<p>Nine months ago I overhauled POE&#8217;s I/O dispatch and Session GC.  I/O dispatch is about 130% faster.  I can&#8217;t quote a number for session GC improvements because it&#8217;s difficult to measure in isolation.  See my post at <a href="http://use.perl.org/~rcaputo/journal/39749" rel="nofollow">http://use.perl.org/~rcaputo/journal/39749</a></p>
<p>Nevertheless, POE&#8217;s not too difficult to use with a limited number of sessions.  In some cases, a singleton session can drive an entire program.  If you can do this, it would totally eliminate session GC as your bottleneck.</p>
<p>My latest project, Reflex, uses a single session to drive any number of objects.  It also minimizes use of POE message passing, which is another source of overhead.  Because of this, Reflex can run faster than POE even though it uses POE.  As I said to James above, POE&#8217;s performance is a factor of how it&#8217;s used, and one of Reflex&#8217;s goals is to use POE well.  See <a href="http://search.cpan.org/dist/Reflex/" rel="nofollow">http://search.cpan.org/dist/Reflex/</a></p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="1404" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="fba5cf5d4b" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="222"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">602 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">375 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">273 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">214 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">161 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">150 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">149 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">133 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">129 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">108 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samoch√≥d</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

